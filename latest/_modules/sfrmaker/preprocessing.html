<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sfrmaker.preprocessing &mdash; SFRmaker 0.11.2.post0.dev0+g2c4daff documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/documentation_options.js?v=2e2dfa67"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../_static/copybutton.js?v=f281be69"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            SFRmaker
          </a>
              <div class="version">
                0.11.2.post0.dev0+g2c4daff
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../philosophy.html"> Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html"> Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html"> Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../inputs.html"> Input Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html"> Using SFRmaker with a configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/SFRmaker_demo.html"> Basic Usage in a scripting context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/preprocessing_demo.html"> Preprocessing NHDPlus version 2 data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/lines_from_NHDPlusHR_demo.html"> Using SFRmaker with NHDPlus High Resolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts.html"> Concepts and methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/sfrmaker_tools.html"> Stand-alone tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html"> Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html"> Code reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config-summary.html"> Summary of configuration file options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-history.html"> Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html"> Contributing to SFRmaker</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Bibliography</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../references.html"> References cited</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SFRmaker</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">sfrmaker.preprocessing</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sfrmaker.preprocessing</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">affine</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">fiona</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">pyproj</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MultiLineString</span><span class="p">,</span> 
    <span class="n">box</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">rasterstats</span> <span class="kn">import</span> <span class="n">zonal_stats</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">colors</span>
<span class="kn">from</span> <span class="nn">gisutils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_shapefile_crs</span><span class="p">,</span> 
    <span class="n">write_raster</span><span class="p">,</span> 
    <span class="n">project</span><span class="p">,</span> 
    <span class="n">shp2df</span><span class="p">,</span> 
    <span class="n">df2shp</span><span class="p">,</span> 
    <span class="n">get_shapefile_crs</span><span class="p">,</span>
    <span class="n">get_authority_crs</span>
    <span class="p">)</span>
<span class="kn">from</span> <span class="nn">sfrmaker.gis</span> <span class="kn">import</span> <span class="p">(</span><span class="n">intersect_rtree</span><span class="p">,</span> <span class="n">get_crs</span><span class="p">,</span>
                          <span class="n">get_bbox</span><span class="p">,</span> <span class="n">read_polygon_feature</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sfrmaker.elevations</span> <span class="kn">import</span> <span class="n">smooth_elevations</span>
<span class="kn">from</span> <span class="nn">sfrmaker.logger</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">sfrmaker.nhdplus_utils</span> <span class="kn">import</span> <span class="n">get_nhdplus_v2_filepaths</span><span class="p">,</span> <span class="n">get_prj_file</span>
<span class="kn">from</span> <span class="nn">sfrmaker.routing</span> <span class="kn">import</span> <span class="n">find_path</span><span class="p">,</span> <span class="n">make_graph</span><span class="p">,</span> <span class="n">get_upsegs</span>
<span class="kn">from</span> <span class="nn">sfrmaker.units</span> <span class="kn">import</span> <span class="n">convert_length_units</span><span class="p">,</span> <span class="n">unit_abbreviations</span>
<span class="kn">from</span> <span class="nn">sfrmaker.utils</span> <span class="kn">import</span> <span class="n">width_from_arbolate_sum</span><span class="p">,</span> <span class="n">arbolate_sum</span>


<div class="viewcode-block" id="get_flowline_routing">
<a class="viewcode-back" href="../../api/sfrmaker.preprocessing.html#sfrmaker.preprocessing.get_flowline_routing">[docs]</a>
<span class="k">def</span> <span class="nf">get_flowline_routing</span><span class="p">(</span><span class="n">NHDPlus_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PlusFlow</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">mask_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nhdplus_crs</span><span class="o">=</span><span class="mi">4269</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a collection of NHDPlus version 2 PlusFlow (routing)</span>
<span class="sd">    tables from one or more drainage basins and consolidate into a </span>
<span class="sd">    single pandas DataFrame, returning the `FROMCOMID` and `TOCOMID` </span>
<span class="sd">    columns.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    NHDPlus_paths : sequence</span>
<span class="sd">        Sequence of paths to the top level folder for each drainage basin.</span>
<span class="sd">        For example: </span>
<span class="sd">        </span>
<span class="sd">        .. code-block:: python</span>
<span class="sd">        </span>
<span class="sd">            [&#39;NHDPlus/NHDPlusGL/NHDPlus04&#39;, </span>
<span class="sd">             &#39;NHDPlus/NHDPlusMS/NHDPlus07&#39;]</span>
<span class="sd">             </span>
<span class="sd">        by default None</span>
<span class="sd">    PlusFlow : string or sequence</span>
<span class="sd">        Single path to a PlusFlow table or sequence of PlusFlow table </span>
<span class="sd">        filepaths, by default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flowline_routing : DataFrame</span>
<span class="sd">        [description]</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        [description]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">NHDPlus_paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flowlines_files</span><span class="p">,</span> <span class="n">pfvaa_files</span><span class="p">,</span> <span class="n">pf_files</span><span class="p">,</span> <span class="n">elevslope_files</span> <span class="o">=</span> \
        <span class="n">get_nhdplus_v2_filepaths</span><span class="p">(</span><span class="n">NHDPlus_paths</span><span class="p">,</span> <span class="n">raise_not_exist_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">pf</span> <span class="o">=</span> <span class="n">shp2df</span><span class="p">(</span><span class="n">pf_files</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">extent_poly_nhd_crs</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">mask</span><span class="p">)</span>
                <span class="n">bbox_filter</span> <span class="o">=</span> <span class="n">mask</span>
            <span class="k">elif</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">extent_poly_nhd_crs</span> <span class="o">=</span> <span class="n">read_polygon_feature</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> 
                                                           <span class="n">feature_crs</span><span class="o">=</span><span class="n">mask_crs</span><span class="p">,</span>
                                                           <span class="n">dest_crs</span><span class="o">=</span><span class="n">nhdplus_crs</span><span class="p">)</span>
                <span class="c1"># ensure that filter bbox is in same crs as flowlines</span>
                <span class="c1"># get filters from shapefiles, shapley Polygons or GeoJSON polygons</span>
                <span class="n">bbox_filter</span> <span class="o">=</span> <span class="n">get_bbox</span><span class="p">(</span><span class="n">extent_poly_nhd_crs</span><span class="p">,</span> <span class="n">dest_crs</span><span class="o">=</span><span class="n">nhdplus_crs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bbox_filter</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">flowlines</span> <span class="o">=</span> <span class="n">shp2df</span><span class="p">(</span><span class="n">flowlines_files</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">bbox_filter</span><span class="p">)</span>
            <span class="n">keep_comids</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="s1">&#39;FROMCOMID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">flowlines</span><span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">])</span> <span class="o">|</span> \
                          <span class="n">pf</span><span class="p">[</span><span class="s1">&#39;TOCOMID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">flowlines</span><span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">])</span>
            <span class="n">pf</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keep_comids</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">PlusFlow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pf</span> <span class="o">=</span> <span class="n">shp2df</span><span class="p">(</span><span class="n">PlusFlow</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;get_flowline_routing: Must provide one of more&quot;</span> 
                          <span class="s2">&quot; NHDPlus_path or PlusFlow table.&quot;</span><span class="p">))</span>
    <span class="n">pf</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pf</span><span class="p">[</span><span class="s1">&#39;FROMCOMID&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pf</span><span class="p">[[</span><span class="s1">&#39;FROMCOMID&#39;</span><span class="p">,</span> <span class="s1">&#39;TOCOMID&#39;</span><span class="p">]]</span></div>

        
    
<div class="viewcode-block" id="cull_flowlines">
<a class="viewcode-back" href="../../api/sfrmaker.preprocessing.html#sfrmaker.preprocessing.cull_flowlines">[docs]</a>
<span class="k">def</span> <span class="nf">cull_flowlines</span><span class="p">(</span><span class="n">NHDPlus_paths</span><span class="p">,</span>
                   <span class="n">active_area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">asum_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">intermittent_streams_asum_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">cull_invalid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">cull_isolated</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">keep_comids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">outfolder</span><span class="o">=</span><span class="s1">&#39;clipped_flowlines&#39;</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cull NHDPlus version2 data to an area defined by an ``active_area`` polygon and</span>
<span class="sd">    to flowlines with Arbolate sums greater than specified thresholds. Also remove</span>
<span class="sd">    lines that are isolated from the stream network or are missing attribute information.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    NHDPlus_paths : list of strings</span>
<span class="sd">        Paths to the root folder level NHDPlus Drainage Basins, as they were downloaded</span>
<span class="sd">        from the NHDPlus website (e.g. NHDPlus04, NHDPlus07, etc.).</span>
<span class="sd">    active_area : str, shapely polygon or tuple, optional</span>
<span class="sd">        A polygon shapefile, or shapely polygon or bounding box tuple</span>
<span class="sd">        (left, bottom, top, right) in the NAD83 GCS (EPSG:4269). The active area</span>
<span class="sd">        is converted to a bounding box, which is then used to filter the flowlines</span>
<span class="sd">        that are read in. If none, no filtering is performed, and the whole</span>
<span class="sd">        area encompased by the input NHDPlus data will be retained.</span>
<span class="sd">        By default None.</span>
<span class="sd">    asum_thresh : numeric, optional</span>
<span class="sd">        Minimum arbolate sum value (total length of upstream drainage) to</span>
<span class="sd">        retain. Any flowlines with arbolate sums less than this value will be dropped.</span>
<span class="sd">        By default None.</span>
<span class="sd">    intermittent_streams_asum_thresh : numeric, optional</span>
<span class="sd">        Minimum arbolate sum value (total length of upstream drainage) to</span>
<span class="sd">        retain for flowlines coded as intermittent (FCODE == 46003).</span>
<span class="sd">        Any intermittent flowlines with arbolate sums less than this value will be dropped.</span>
<span class="sd">        By default None.</span>
<span class="sd">    cull_invalid : bool, optional</span>
<span class="sd">        Option to cull flowlines that have incomplete attribute information</span>
<span class="sd">        (lacking entries in the PlusFlowVAA, PlusFlow or Elevslope tables), by default False.</span>
<span class="sd">    cull_isolated : bool, optional</span>
<span class="sd">        Culling intermittent streams with intermittent_streams_asum_thresh may result</span>
<span class="sd">        in some isolated flowlines that no longer have downstream connections, or</span>
<span class="sd">        such isolated flowlines may be present in the raw NHDPlus data.</span>
<span class="sd">        SFRmaker identifies isolated flowslines by looking at up to 10 downstream connections</span>
<span class="sd">        to lines that are not stream network. Option to drop</span>
<span class="sd">        these lines. By default, False.</span>
<span class="sd">    keep_comids : sequence</span>
<span class="sd">        List-like of COMIDs to retain, regardless of culling criteria.</span>
<span class="sd">    outfolder : str, optional</span>
<span class="sd">        Location for writing output, by default &#39;clipped_flowlines&#39;</span>
<span class="sd">    logger : sfrmaker.logger instance, optional</span>
<span class="sd">        Pass an existing sfrmaker.logger instance to logger the preprocessing operations,</span>
<span class="sd">        by default None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Culling NHDPlus dataset&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Reading raw NHDPlus files&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outfolder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outfolder</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;created </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfolder</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">asum_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">asum_thresh</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_gt</span><span class="si">{</span><span class="n">asum_thresh</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">km&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">flowlines_files</span><span class="p">,</span> <span class="n">pfvaa_files</span><span class="p">,</span> <span class="n">pf_files</span><span class="p">,</span> <span class="n">elevslope_files</span> <span class="o">=</span> \
        <span class="n">get_nhdplus_v2_filepaths</span><span class="p">(</span><span class="n">NHDPlus_paths</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">keep_comids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">keep_comids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">keep_comids</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">keep_comids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        
    <span class="c1"># logger the date modified timestamps for the NHDPlus files</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flowlines_files</span> <span class="o">+</span> <span class="n">pfvaa_files</span> <span class="o">+</span> <span class="n">pf_files</span> <span class="o">+</span> <span class="n">elevslope_files</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log_file_and_date_modified</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># get crs information from flowline projection file</span>
    <span class="n">prjfile</span> <span class="o">=</span> <span class="n">get_prj_file</span><span class="p">(</span><span class="n">NHDPlus_paths</span><span class="p">)</span>
    <span class="n">nhdcrs</span> <span class="o">=</span> <span class="n">get_shapefile_crs</span><span class="p">(</span><span class="n">prjfile</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">active_area</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">extent_poly_nhd_crs</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">active_area</span><span class="p">)</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="n">active_area</span>
    <span class="k">elif</span> <span class="n">active_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">extent_poly_nhd_crs</span> <span class="o">=</span> <span class="n">read_polygon_feature</span><span class="p">(</span><span class="n">active_area</span><span class="p">,</span> <span class="n">dest_crs</span><span class="o">=</span><span class="n">nhdcrs</span><span class="p">)</span>
        <span class="c1"># ensure that filter bbox is in same crs as flowlines</span>
        <span class="c1"># get filters from shapefiles, shapley Polygons or GeoJSON polygons</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="n">get_bbox</span><span class="p">(</span><span class="n">active_area</span><span class="p">,</span> <span class="n">dest_crs</span><span class="o">=</span><span class="n">nhdcrs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># read NHDPlus files into pandas dataframes</span>
    <span class="n">fl</span> <span class="o">=</span> <span class="n">shp2df</span><span class="p">(</span><span class="n">flowlines_files</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">)</span>
    <span class="n">fl_all</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">pfvaa</span> <span class="o">=</span> <span class="n">shp2df</span><span class="p">(</span><span class="n">pfvaa_files</span><span class="p">)</span>
    <span class="n">pf</span> <span class="o">=</span> <span class="n">shp2df</span><span class="p">(</span><span class="n">pf_files</span><span class="p">)</span>
    <span class="n">elevslope</span> <span class="o">=</span> <span class="n">shp2df</span><span class="p">(</span><span class="n">elevslope_files</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Reading raw NHDPlus files&#39;</span><span class="p">)</span>

    <span class="c1"># index dataframes by common-identifier numbers</span>
    <span class="c1"># drop any entries without ID numbers</span>
    <span class="c1"># enforce integer dtype in ID numbers</span>
    <span class="n">fl</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fl</span><span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">COMID</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
    <span class="n">fl</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">fl</span><span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">]</span>
    <span class="n">pfvaa</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ComID&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pfvaa</span><span class="p">[</span><span class="s1">&#39;ComID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfvaa</span><span class="o">.</span><span class="n">ComID</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
    <span class="n">pfvaa</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pfvaa</span><span class="p">[</span><span class="s1">&#39;ComID&#39;</span><span class="p">]</span>
    <span class="n">pf</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;FROMCOMID&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pf</span><span class="p">[</span><span class="s1">&#39;FROMCOMID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">FROMCOMID</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
    <span class="n">pf</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pf</span><span class="p">[</span><span class="s1">&#39;FROMCOMID&#39;</span><span class="p">]</span>
    <span class="n">elevslope</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">elevslope</span><span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">elevslope</span><span class="o">.</span><span class="n">COMID</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>
    <span class="n">elevslope</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">elevslope</span><span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">]</span>

    <span class="n">original_comids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cull_invalid</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;Dropping flowlines without attribute information&#39;</span><span class="p">)</span>
        <span class="c1"># only retain comids that have information in all of the tables</span>
        
        <span class="n">valid_comids</span> <span class="o">=</span> <span class="n">original_comids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">pfvaa</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">intersection</span><span class="p">(</span><span class="n">pf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">elevslope</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        
        <span class="c1"># order the same as flowlines</span>
        <span class="n">valid_comids</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">fl</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">valid_comids</span><span class="p">]</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_comids</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">pfvaa</span> <span class="o">=</span> <span class="n">pfvaa</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_comids</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">pf</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_comids</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">elevslope</span> <span class="o">=</span> <span class="n">elevslope</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_comids</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dropped</span> <span class="o">=</span> <span class="n">original_comids</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">valid_comids</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">dropped</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;Dropping </span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> lines&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dropped</span><span class="p">),</span>
                                                              <span class="nb">len</span><span class="p">(</span><span class="n">original_comids</span><span class="p">)),</span>
                             <span class="n">log_time</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">valid_comids</span> <span class="o">=</span> <span class="n">original_comids</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">keep_comids</span><span class="p">)</span>
        <span class="c1"># remove attribute information for COMIDs that don&#39;t have flowlines</span>
        <span class="n">pfvaa</span> <span class="o">=</span> <span class="n">pfvaa</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="kc">True</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">original_comids</span>
                           <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pfvaa</span><span class="o">.</span><span class="n">index</span><span class="p">]]</span>
        <span class="n">pf</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="kc">True</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">original_comids</span>
                     <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pf</span><span class="o">.</span><span class="n">index</span><span class="p">]]</span>
        <span class="n">elevslope</span> <span class="o">=</span> <span class="n">elevslope</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="kc">True</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">original_comids</span>
                                   <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">elevslope</span><span class="o">.</span><span class="n">index</span><span class="p">]]</span>
        <span class="c1"># add attribute information for any flowlines without attributes</span>
        <span class="c1"># assign an arbitrary asum of 1</span>
        <span class="c1"># (user will have to manually edit these invalid COMIDs later,</span>
        <span class="c1"># or in this case, the minimum stream width would be assigned)</span>
        <span class="n">pfvaa_difference</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">COMID</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">pfvaa</span><span class="o">.</span><span class="n">ComID</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pfvaa_difference</span><span class="p">):</span>
            <span class="n">to_append</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;ComID&#39;</span><span class="p">:</span> <span class="n">pfvaa_difference</span><span class="p">,</span>
                <span class="s1">&#39;ArbolateSu&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">pfvaa_difference</span><span class="p">)},</span> 
            <span class="n">index</span><span class="o">=</span><span class="n">pfvaa_difference</span><span class="p">)</span>
            <span class="n">pfvaa</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pfvaa</span><span class="p">,</span> <span class="n">to_append</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># add any missing COMIDs to routing table</span>
        <span class="c1"># fill to comids with 0s (outlet condition)</span>
        <span class="n">pf_difference</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">COMID</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">pf</span><span class="o">.</span><span class="n">FROMCOMID</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pf_difference</span><span class="p">):</span>
            <span class="n">to_append</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;FROMCOMID&#39;</span><span class="p">:</span> <span class="n">pf_difference</span><span class="p">,</span>
                <span class="s1">&#39;TOCOMID&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">pf_difference</span><span class="p">)},</span> 
            <span class="n">index</span><span class="o">=</span><span class="n">pf_difference</span><span class="p">)</span>
            <span class="n">pf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pf</span><span class="p">,</span> <span class="n">to_append</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># add any missing COMIDs to elevations table</span>
        <span class="c1"># fill missing elevations with zeros</span>
        <span class="n">elevslope_difference</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">COMID</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">elevslope</span><span class="o">.</span><span class="n">COMID</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">elevslope_difference</span><span class="p">):</span>
            <span class="n">to_append</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;COMID&#39;</span><span class="p">:</span> <span class="n">elevslope_difference</span><span class="p">,</span>
                <span class="s1">&#39;MAXELEVSMO&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">elevslope_difference</span><span class="p">),</span> 
                <span class="s1">&#39;MELEVSMO&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">elevslope_difference</span><span class="p">)},</span> 
                <span class="n">index</span><span class="o">=</span><span class="n">elevslope_difference</span><span class="p">)</span>
            <span class="n">elevslope</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">elevslope</span><span class="p">,</span> <span class="n">to_append</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">assert</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_integer_dtype</span><span class="p">(</span><span class="n">pfvaa</span><span class="p">[</span><span class="s1">&#39;ComID&#39;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_integer_dtype</span><span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="s1">&#39;FROMCOMID&#39;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_integer_dtype</span><span class="p">(</span><span class="n">elevslope</span><span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">])</span>

    <span class="n">fl</span><span class="p">[</span><span class="s1">&#39;nhd_asum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfvaa</span><span class="o">.</span><span class="n">ArbolateSu</span>

    <span class="c1"># cull by arbolate sum first</span>
    <span class="k">if</span> <span class="n">asum_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;Dropping Flowlines with arbolate sum less than </span><span class="si">{}</span><span class="s1">km&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">asum_thresh</span><span class="p">))</span>
        <span class="c1"># exclude streams classified as perennial from threshold</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">FCODE</span> <span class="o">==</span> <span class="mi">46006</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">nhd_asum</span> <span class="o">&gt;=</span> <span class="n">asum_thresh</span><span class="p">)</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span> <span class="o">|</span> <span class="n">fl</span><span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">keep_comids</span><span class="p">)</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">criteria</span><span class="p">]</span>

    <span class="c1"># then cull intermittent streams</span>
    <span class="k">if</span> <span class="n">intermittent_streams_asum_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;Dropping intermittent streams with arbolate sum less than </span><span class="si">{}</span><span class="s1">km&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intermittent_streams_asum_thresh</span><span class="p">))</span>
        <span class="n">drop_intermittent</span> <span class="o">=</span> <span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">nhd_asum</span> <span class="o">&lt;</span> <span class="n">intermittent_streams_asum_thresh</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">FCODE</span> <span class="o">==</span> <span class="mi">46003</span><span class="p">)</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="o">~</span><span class="n">drop_intermittent</span> <span class="o">|</span> <span class="n">fl</span><span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">keep_comids</span><span class="p">)</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">criteria</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">cull_isolated</span><span class="p">:</span>
        <span class="c1"># drop any remaining stream segments that are isolated</span>
        <span class="c1"># (segments marked as perennial that routed to segment(s) marked as intermittent)</span>
        <span class="c1"># looking at Google Satellite, many intermittent segments appear to no longer exist</span>
        <span class="c1"># (occur in middle of fields, etc.)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Removing isolated flowlines that are no longer in the network&#39;</span><span class="p">)</span>
        <span class="c1"># quick and dirty routing graph</span>
        <span class="c1"># technically not correct, because some flowlines have more than one distrib.</span>
        <span class="c1"># the tocomid chosen will be the last one element-wise in the plusflow table</span>
        <span class="c1"># this should be fine because there weren&#39;t many isolated COMIDs in the MAP area</span>
        <span class="n">comids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">COMID</span><span class="p">)</span>
        <span class="n">tocomid</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pf</span><span class="o">.</span><span class="n">FROMCOMID</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pf</span><span class="o">.</span><span class="n">TOCOMID</span><span class="p">]</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">pf</span><span class="o">.</span><span class="n">FROMCOMID</span><span class="p">,</span> <span class="n">tocomid</span><span class="p">))</span>
        <span class="n">fl</span><span class="p">[</span><span class="s1">&#39;tocomid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">graph</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">fl</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">geoms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fl_all</span><span class="o">.</span><span class="n">COMID</span><span class="p">,</span> <span class="n">fl_all</span><span class="o">.</span><span class="n">geometry</span><span class="p">))</span>
        <span class="n">drop_comids</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">COMID</span><span class="p">):</span>
            <span class="c1"># skip comids already in drop list</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">drop_comids</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">find_path</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">dnid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="c1"># if the downstream flowline is not in the SFR network</span>
                <span class="k">if</span> <span class="n">dnid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dnid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">comids</span><span class="p">:</span>
                    <span class="c1"># but is within the model domain and a stream</span>
                    <span class="c1"># it was dropped</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">geoms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dnid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">dnid_fcode</span> <span class="o">=</span> <span class="n">pfvaa</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dnid</span><span class="p">,</span> <span class="s1">&#39;Fcode&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">g</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">extent_poly_nhd_crs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dnid_fcode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">56600</span> <span class="c1"># coastline</span>
                                                                                           <span class="p">]:</span>
                        <span class="c1"># drop current comid and all upstream comids</span>
                        <span class="n">drop_comids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">path</span><span class="p">[:</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="k">break</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="o">~</span><span class="n">fl</span><span class="o">.</span><span class="n">COMID</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">drop_comids</span><span class="p">)</span> <span class="o">|</span> <span class="n">fl</span><span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">keep_comids</span><span class="p">)</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">criteria</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Removing isolated flowlines that are no longer in the network&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;Removed </span><span class="si">{}</span><span class="s1"> of </span><span class="si">{}</span><span class="s1"> flowlines&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">drop_comids</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                                             <span class="nb">len</span><span class="p">(</span><span class="n">comids</span><span class="p">)),</span>
                         <span class="n">log_time</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># write output files</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;writing output&#39;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flowlines_file&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/flowlines</span><span class="si">{}</span><span class="s1">.shp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">version</span><span class="p">),</span>
               <span class="s1">&#39;pfvaa_file&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/PlusFlowlineVAA</span><span class="si">{}</span><span class="s1">.dbf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">version</span><span class="p">),</span>
               <span class="s1">&#39;pf_file&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/PlusFlow</span><span class="si">{}</span><span class="s1">.dbf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">version</span><span class="p">),</span>
               <span class="s1">&#39;elevslope_file&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/elevslope</span><span class="si">{}</span><span class="s1">.dbf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
               <span class="p">}</span>
    <span class="n">df2shp</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;flowlines_file&#39;</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="mi">4269</span><span class="p">)</span>
    <span class="n">df2shp</span><span class="p">(</span><span class="n">pfvaa</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;pfvaa_file&#39;</span><span class="p">])</span>
    <span class="n">df2shp</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;pf_file&#39;</span><span class="p">])</span>
    <span class="n">df2shp</span><span class="p">(</span><span class="n">elevslope</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;elevslope_file&#39;</span><span class="p">])</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Culling NHDPlus dataset&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span></div>



<div class="viewcode-block" id="preprocess_nhdplus">
<a class="viewcode-back" href="../../api/sfrmaker.preprocessing.html#sfrmaker.preprocessing.preprocess_nhdplus">[docs]</a>
<span class="k">def</span> <span class="nf">preprocess_nhdplus</span><span class="p">(</span><span class="n">flowlines_file</span><span class="p">,</span> <span class="n">pfvaa_file</span><span class="p">,</span>
                       <span class="n">pf_file</span><span class="p">,</span> <span class="n">elevslope_file</span><span class="p">,</span>
                       <span class="n">demfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">run_zonal_statistics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">dem_length_units</span><span class="o">=</span><span class="s1">&#39;meters&#39;</span><span class="p">,</span>
                       <span class="n">flowline_elevations_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">active_area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">narwidth_shapefile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">waterbody_shapefiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># for sampling NARWidth</span>
                       <span class="n">buffersize_meters</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                       <span class="n">asum_thresh</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                       <span class="n">known_connections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">update_up_elevations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">update_dn_elevations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">width_from_asum_a_param</span><span class="o">=</span><span class="mf">0.1193</span><span class="p">,</span>
                       <span class="n">width_from_asum_b_param</span><span class="o">=</span><span class="mf">0.5032</span><span class="p">,</span>
                       <span class="n">minimum_width</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                       <span class="n">output_length_units</span><span class="o">=</span><span class="s1">&#39;meters&#39;</span><span class="p">,</span>
                       <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outfolder</span><span class="o">=</span><span class="s1">&#39;output/&#39;</span><span class="p">,</span>
                       <span class="n">flowline_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dest_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Preprocess NHDPlus data to a single DataFrame of flowlines</span>
<span class="sd">    that each route to no more than one flowline, with width, elevation</span>
<span class="sd">    and recomputed arbolate sum attributes. A key part of the preprocessing is handling divergences in the stream network, as described in more detail in the ``Notes`` section. In picking routing at divergences, values are sampled from the ``demfile`` and included in the output DataFrame. Optionally (via the ``narwidth_shapefile`` arguement), remote sensing-based width estimates from the NARWidth Database (Allen and Pavelsky, 2015) can be included.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    flowlines_file : str</span>
<span class="sd">        Path to NHDPlus NHDFlowline shapefile. May or maybe not have been</span>
<span class="sd">        preprocessed by :func:`~sfrmaker.preprocessing.cull_flowlines`. The flowlines</span>
<span class="sd">        must be in a valid projected coorinate reference system (CRS; i.e., with units of meters),</span>
<span class="sd">        or a valid projected CRS must be specified with ``flowline_crs``.</span>
<span class="sd">    pfvaa_file : str</span>
<span class="sd">        Path to NHDPlus PlusFlowlineVAA database (.dbf file). May or maybe not have been</span>
<span class="sd">        preprocessed by :func:`~sfrmaker.preprocessing.cull_flowlines`. ``ArbolateSu``</span>
<span class="sd">        values within this file are assumed to be in km.</span>
<span class="sd">    pf_file : str</span>
<span class="sd">        Path to NHDPlus PlusFlow database (.dbf file). May or maybe not have been</span>
<span class="sd">        preprocessed by :func:`~sfrmaker.preprocessing.cull_flowlines`</span>
<span class="sd">    elevslope_file : str</span>
<span class="sd">        Path to NHDPlus elevslope database (.dbf file). May or maybe not have been</span>
<span class="sd">        preprocessed by :func:`~sfrmaker.preprocessing.cull_flowlines`</span>
<span class="sd">    demfile : str</span>
<span class="sd">        Path to DEM raster for project area.</span>
<span class="sd">    dem_length_units : str, any length unit; e.g. {&#39;m&#39;, &#39;meters&#39;, &#39;ft&#39;, etc.}</span>
<span class="sd">        Length units of values in ``demfile``. By default, &#39;meters&#39;.</span>
<span class="sd">    active_area : str, optional</span>
<span class="sd">        Polygon shapefile of active area that preprocessed lines will be clipped to.</span>
<span class="sd">        By default, None, in which case the flowlines won&#39;t be clipped.</span>
<span class="sd">    narwidth_shapefile : str, optional</span>
<span class="sd">        Path to shapefile from the NARWidth database (Allen and Pavelsky, 2015).</span>
<span class="sd">    waterbody_shapefiles : str or list of strings, optional</span>
<span class="sd">        Path(s) to NHDPlus NHDWaterbody shapefile(s). Only required if a</span>
<span class="sd">        ``narwidth_shapefile`` is specified.</span>
<span class="sd">    buffersize_meters : float</span>
<span class="sd">        Buffer distance in meters around flowlines to include when sampling DEM.</span>
<span class="sd">        By default, 50.</span>
<span class="sd">    asum_thresh : float</span>
<span class="sd">        Arbolate sum threshold for culling minor distributaries</span>
<span class="sd">        (that are not the main channel) below divergences.</span>
<span class="sd">        In NHDPlus, minor distributaries have the same arbolate sum as the main channel.</span>
<span class="sd">        After selecting the main channel, SFRmaker recomputes arbolate sum values</span>
<span class="sd">        for the minor distributaries, starting with 0 at the divergence. Lines with</span>
<span class="sd">        ending asums less than ``asum_thresh`` will then be culled.</span>
<span class="sd">    known_connections : dict, optional</span>
<span class="sd">        Dictionary of specified flowline connections {COMID: tocomid},</span>
<span class="sd">        which will override the routing selection at distributaries.</span>
<span class="sd">        By default None.</span>
<span class="sd">    update_up_elevations : dict, optional</span>
<span class="sd">        Dictionary of specified stage or streambed top elevations </span>
<span class="sd">        {COMID: elevation} at the upstream end of flowlines, for example,</span>
<span class="sd">        based on field measurements of streambed elevation or stage. The distinction between</span>
<span class="sd">        streambed elevation and stage depends on the context of the other elevations. </span>
<span class="sd">        For example, DEM elevations for larger streams typically reflect stage</span>
<span class="sd">        at the time data for the DEM (e.g. lidar) were collected. If all other COMID elevations</span>
<span class="sd">        represent stage, then the elevations supplied to `update_up_elevations`</span>
<span class="sd">        and `update_dn_elevations` should be stages. Streambed top is </span>
<span class="sd">        often poorly characterized and difficult to measure in the field. </span>
<span class="sd">        But if the SFR package is simulating stage (specified streambed bottom plus a </span>
<span class="sd">        simulated depth based on flow), appropriate streambed bottom input is needed</span>
<span class="sd">        to produce reasonable stages. The user may start with DEM elevations and then </span>
<span class="sd">        later subtract off simulated stream depths(from the SFR package output) </span>
<span class="sd">        to arrive at simulated stages that are close to those observed in the field.</span>
<span class="sd">        </span>
<span class="sd">        `update_up_elevations` and `update_dn_elevations` input will override any other values </span>
<span class="sd">        (from NHDPlus or the DEM), and will be incorporated into the elevation smoothing.</span>
<span class="sd">        By default None.</span>
<span class="sd">    update_dn_elevations : dict, optional</span>
<span class="sd">        Dictionary of specified elevations {COMID: elevation} at the downstream </span>
<span class="sd">        end of flowlines. See the `update_up_elevations` description for more details.</span>
<span class="sd">        </span>
<span class="sd">        `update_up_elevations` and `update_dn_elevations` input will override any other values </span>
<span class="sd">        (from NHDPlus or the DEM), and will be incorporated into the elevation smoothing.</span>
<span class="sd">        By default None.</span>
<span class="sd">    width_from_asum_a_param : float, optional</span>
<span class="sd">        :math:`a` parameter used for estimating channel width from arbolate sum.</span>
<span class="sd">        Only needed if input flowlines are lacking width information.</span>
<span class="sd">        See :func:`~sfrmaker.utils.width_from_arbolate`. By default, 0.1193.</span>
<span class="sd">    width_from_asum_b_param : float, optional</span>
<span class="sd">        :math:`b` parameter used for estimating channel width from arbolate sum.</span>
<span class="sd">        Only needed if input flowlines are lacking width information.</span>
<span class="sd">        See :func:`~sfrmaker.utils.width_from_arbolate`. By default, 0.5032.</span>
<span class="sd">    minimum_width : float, optional</span>
<span class="sd">        Minimum reach width to specify (in model units), if computing widths from</span>
<span class="sd">        arbolate sum values. (default = 1)</span>
<span class="sd">    output_length_units : str, any length unit; e.g. {&#39;m&#39;, &#39;meters&#39;, &#39;ft&#39;, etc.}</span>
<span class="sd">        Units for width and elevation attribute values included with the output flowlines.</span>
<span class="sd">        Output arbolate sum values are specified in kilometers.</span>
<span class="sd">    outfolder : str, optional</span>
<span class="sd">        Location for writing output, by default &#39;clipped_flowlines&#39;</span>
<span class="sd">    logger : sfrmaker.logger instance, optional</span>
<span class="sd">        Pass an existing sfrmaker.logger instance to logger the preprocessing operations,</span>
<span class="sd">        by default None</span>
<span class="sd">    flowline_crs : obj</span>
<span class="sd">        Coordinate reference system of the NHDPlus data. Only needed if</span>
<span class="sd">        the data do not have a valid ESRI projection (.prj) file.</span>
<span class="sd">        A Python int, dict, str, or :class:`pyproj.crs.CRS` instance</span>
<span class="sd">        passed to :meth:`pyproj.crs.CRS.from_user_input`</span>

<span class="sd">        Can be any of:</span>
<span class="sd">          - PROJ string</span>
<span class="sd">          - Dictionary of PROJ parameters</span>
<span class="sd">          - PROJ keyword arguments for parameters</span>
<span class="sd">          - JSON string with PROJ parameters</span>
<span class="sd">          - CRS WKT string</span>
<span class="sd">          - An authority string [i.e. &#39;epsg:4326&#39;]</span>
<span class="sd">          - An EPSG integer code [i.e. 4326]</span>
<span class="sd">          - A tuple of (&quot;auth_name&quot;: &quot;auth_code&quot;) [i.e (&#39;epsg&#39;, &#39;4326&#39;)]</span>
<span class="sd">          - An object with a `to_wkt` method.</span>
<span class="sd">          - A :class:`pyproj.crs.CRS` class</span>
<span class="sd">    dest_crs : obj</span>
<span class="sd">        Output Coordinate reference system. Same input types</span>
<span class="sd">        as ``flowline_crs``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flowlines : DataFrame</span>
<span class="sd">        DataFrame with preprocessed flowlines. Width and elevation values are specified</span>
<span class="sd">        in the ``output_length_units``. Output arbolate sum values are specified</span>
<span class="sd">        in kilometers. See NHDPlus documentation for description of fields not</span>
<span class="sd">        included here. Columns:</span>

<span class="sd">        =========================== ================  ==============================================</span>
<span class="sd">        **COMID**                   int64             NHDPlus Common Identifiers</span>
<span class="sd">        **tocomid**                 int64             Downstream routing connections (COMIDs)</span>
<span class="sd">        **nhd_asum**                float             Arbolate sum from NHDPlus, in km</span>
<span class="sd">        **min**                     float             minimum elevation sampled within each buffer</span>
<span class="sd">        **mean**                    float             mean elevation sampled within each buffer</span>
<span class="sd">        **pct10,20,80**             float             elevation percentiles sampled within each buffer</span>
<span class="sd">        **Divergence**              int               NHDPlus Divergence classification</span>
<span class="sd">        **main_chan**               bool              Flag indicating whether SFRmaker identified line as main channel</span>
<span class="sd">        **elevup**                  float             Smoothed elevation at line start (sampled from DEM)</span>
<span class="sd">        **elevdn**                  float             Smoothed elevation at line end (sampled from DEM)</span>
<span class="sd">        **elevupsmo**               float             Smoothed elevation at line start (sampled from DEM)</span>
<span class="sd">        **elevdnsmo**               float             Smoothed elevation at line end (sampled from DEM)</span>
<span class="sd">        **asum_calc**               float             Recomputed arbolate sum for line (after removing distributaries)</span>
<span class="sd">        **asum_diff**               float             Difference between recomputed and NHDPlus asums</span>
<span class="sd">        **width1asum**              float             asum-based estimate for width at line start</span>
<span class="sd">        **width2asum**              float             asum-based estimate for width at line end</span>
<span class="sd">        **narwd_n**                 int               number of values for line sampled from NARWidth</span>
<span class="sd">        **narwd_mean**              float             mean elevation sampled from NARWidth</span>
<span class="sd">        **narwd_std**               float             standard deviation in values sampled from NARWidth</span>
<span class="sd">        **narwd_min**               float             minimum elevation sampled from NARWidth</span>
<span class="sd">        **narwd_max**               float             maximum elevation sampled from NARWidth</span>
<span class="sd">        **is_wb**                   bool              Flag for whether the line coincides with a Waterbody</span>
<span class="sd">        **width1**                  float             estimated width at line start (from NARWidth or asum)</span>
<span class="sd">        **width2**                  float             estimated width at line end (from NARWidth or asum)</span>
<span class="sd">        **geometry**                obj               Shapely LineString for each line</span>
<span class="sd">        **buffpoly**                obj               Shapely Polygon (buffer) around each LineString</span>
<span class="sd">        =========================== ================  ==============================================</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        [description]</span>
<span class="sd">    IOError</span>
<span class="sd">        [description]</span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    A key part of the preprocessing is handling divergences in the stream network, where flow is routed to two or more distributaries. Distributaries are common in the Mississippi Alluvial Plain (MAP) region, for example, but in reality, most of these features are either non-existent or only carry flow intermittently during high-water events. While distributaries in NHDPlus are classified as “main” and “minor” paths at divergences, inspection against the satellite imagery and the most recent, `lidar-based DEMs for the MAP area &lt;https://viewer.nationalmap.gov/basic/&gt;`_ suggested that the NHDPlus classifications are often inaccurate. </span>

<span class="sd">    The following steps are taken to identify the main channel at each divergence:</span>
<span class="sd">    </span>
<span class="sd">    •	A 50-meter buffer polygon is drawn around each flowline feature. A flat end-cap is used, so that only areas perpendicular to the flowlines are included in each buffer.</span>
<span class="sd">    •	Zonal statistics for the lidar-based DEM values within each buffer polygon are computed using the `rasterstats python package &lt;https://pythonhosted.org/rasterstats/&gt;`_. The tenth percentile elevation is selected as a metric for discriminating between the main channel and minor distributaries. Lower elevation percentiles would be more likely to represent areas of overlap between the buffers for the main channel and minor distributaries (resulting in minor distributary values that are similar to the main channel), while higher elevation percentiles might miss the lowest parts of the main channel or even represent parts of the channel banks instead.</span>
<span class="sd">    •	At each divergence, the distributary with the lowest tenth percentile elevation is assumed to be the main channel. </span>
<span class="sd">    </span>
<span class="sd">    In the MAP region, comparison of the sampled DEM values with the NHDPlus elevation attribute data revealed a high bias in many of the attribute values, especially in the vicinity of diversions. This may be a result of the upstream smoothing process described by McKay and others (2012, p 123) when it encounters distributaries of unequal values such as the example shown in Figure 5. To remedy this issue, the 10th percentile values obtained from the buffer zonal statistics were assigned to each flowline, and then smoothed in the downstream direction to ensure that no flowlines had negative (uphill) slopes.</span>
<span class="sd">    </span>
<span class="sd">    Finally, routing connections to minor distributaries are removed, and arbolate sums recomputed for the entire stream network, with arbolate sums at minor distributaries starting at zero. In this way, the minor distributaries are treated like headwater streams in that they will only receive flow if the water table is greater than their assigned elevation, otherwise they are simulated as dry and are not part of the groundwater model solution. Similar to :func:`~sfrmaker.preprocessing.cull_flowlines`, the first ``asum_thresh`` km of minor distributaries are trimmed from the stream network.</span>

<span class="sd">    If a shapefile is specified for the ``narwidth_shapefile`` argument, the :func:`~sfrmaker.preprocessing.sample_narwidth` function is called.</span>

<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># check that all the input files exist</span>
    <span class="n">files_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">flowlines_file</span><span class="p">,</span>
                  <span class="n">pfvaa_file</span><span class="p">,</span>
                  <span class="n">pf_file</span><span class="p">,</span>
                  <span class="n">elevslope_file</span><span class="p">,</span>
                  <span class="p">]</span>
    <span class="k">if</span> <span class="n">run_zonal_statistics</span> <span class="ow">and</span> <span class="n">demfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">demfile</span><span class="p">):</span>
        <span class="n">files_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">demfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">narwidth_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">waterbody_shapefiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;NARWidth option &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">waterbody_shapefiles</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">waterbody_shapefiles</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                <span class="n">waterbody_shapefiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">waterbody_shapefiles</span><span class="p">]</span>
            <span class="n">files_list</span> <span class="o">+=</span> <span class="n">waterbody_shapefiles</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_list</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="s2">&quot;missing </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">known_connections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">known_connections</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>

    <span class="n">outfolder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">outfolder</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Preprocessing Flowlines&#39;</span><span class="p">)</span>

    <span class="c1"># read NHDPlus files into pandas dataframes</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">flowlines_file</span><span class="p">,</span> <span class="n">pfvaa_file</span><span class="p">,</span> <span class="n">pf_file</span><span class="p">,</span> <span class="n">elevslope_file</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log_file_and_date_modified</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># get the flowline CRS, if geographic,</span>
    <span class="c1"># verify that project_crs is specified</span>
    <span class="n">prjfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">flowlines_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.prj&#39;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">prjfile</span><span class="p">):</span>
        <span class="n">flowline_crs</span> <span class="o">=</span> <span class="n">get_shapefile_crs</span><span class="p">(</span><span class="n">prjfile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> not found; flowlines must have a valid projection file.&quot;</span>
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prjfile</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dest_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">project_crs</span> <span class="o">=</span> <span class="n">get_crs</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">dest_crs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">project_crs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">project_crs</span><span class="o">.</span><span class="n">is_geographic</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;dest_crs for a valid Projected CRS (i.e. in units of meters)</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="s2">&quot; must be specified if flowlines are in a Geographic CRS</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;specified dest_crs: </span><span class="si">{</span><span class="n">dest_crs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">lraise</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    

    <span class="c1"># get bounds of flowlines</span>
    <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">flowlines_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">flowline_bbox</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

    <span class="n">fl</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">flowlines_file</span><span class="p">)</span> <span class="c1"># flowlines clipped to model area</span>
    <span class="n">pfvaa</span> <span class="o">=</span> <span class="n">shp2df</span><span class="p">(</span><span class="n">pfvaa_file</span><span class="p">)</span>
    <span class="n">pf</span> <span class="o">=</span> <span class="n">shp2df</span><span class="p">(</span><span class="n">pf_file</span><span class="p">)</span>
    <span class="n">elevslope</span> <span class="o">=</span> <span class="n">shp2df</span><span class="p">(</span><span class="n">elevslope_file</span><span class="p">)</span>

    <span class="c1"># index dataframes by common-identifier numbers</span>
    <span class="n">pfvaa</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pfvaa</span><span class="o">.</span><span class="n">ComID</span>
    <span class="n">pf</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">FROMCOMID</span>
    <span class="n">elevslope</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">elevslope</span><span class="o">.</span><span class="n">COMID</span>
    <span class="n">fl</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">COMID</span>

    <span class="c1"># subset attribute tables to clipped flowlines</span>
    <span class="n">pfvaa</span> <span class="o">=</span> <span class="n">pfvaa</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fl</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="n">pf</span> <span class="o">=</span> <span class="n">pf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fl</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="n">elevslope</span> <span class="o">=</span> <span class="n">elevslope</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fl</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

    <span class="c1"># to_crs the flowlines if they are not in project_crs</span>
    <span class="k">if</span> <span class="n">project_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">flowline_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">project_crs</span> <span class="o">!=</span> <span class="n">flowline_crs</span><span class="p">:</span>
        <span class="c1">#fl[&#39;geometry&#39;] = project(fl.geometry, flowline_crs, project_crs)</span>
        <span class="n">fl</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">project_crs</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># option to reuse shapefile from previous run instead of re-running zonal statistics</span>
    <span class="c1"># which can take an hour for large problems</span>
    <span class="k">if</span> <span class="n">run_zonal_statistics</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Path</span><span class="p">(</span><span class="n">demfile</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span> \
            <span class="s2">&quot;If run_zonal_statistics=True (default), a demfile is needed.&quot;</span>
        <span class="c1"># draw buffers</span>
        <span class="n">flbuffers</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffersize_meters</span><span class="p">,</span> <span class="n">cap_style</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 2 (flat cap) very important!</span>
                     <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">fl</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>

        <span class="c1"># Create buffer around flowlines with flat cap, so that ends are flush with ends of lines</span>
        <span class="c1"># compute zonal statistics on buffer</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Creating buffers and running zonal statistics&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log_package_version</span><span class="p">(</span><span class="s1">&#39;rasterstats&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;buffersize: </span><span class="si">{}</span><span class="s1"> m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">buffersize_meters</span><span class="p">),</span> <span class="n">log_time</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log_file_and_date_modified</span><span class="p">(</span><span class="n">demfile</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;DEM file: &#39;</span><span class="p">)</span>

        <span class="c1"># if DEM has different crs, project buffer polygons to DEM crs</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">demfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span>
            <span class="n">dem_crs</span> <span class="o">=</span> <span class="n">get_authority_crs</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">])</span>
            <span class="n">dem_res</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">flbuffers_pr</span> <span class="o">=</span> <span class="n">flbuffers</span>
        <span class="k">if</span> <span class="n">project_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dem_crs</span> <span class="o">!=</span> <span class="n">project_crs</span><span class="p">:</span>
            <span class="n">flbuffers_pr</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">flbuffers</span><span class="p">,</span> <span class="n">project_crs</span><span class="p">,</span> <span class="n">dem_crs</span><span class="p">)</span>

        <span class="c1"># run zonal statistics on buffers</span>
        <span class="c1"># this step takes at least ~ 20 min for the full 1-mi MERAS model</span>
        <span class="c1"># with large cell sizes, count all cells that are touched by each buffer</span>
        <span class="c1"># (not just the cell centers that are intersected)</span>
        <span class="n">all_touched</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">buffersize_meters</span> <span class="o">&lt;</span> <span class="n">dem_res</span><span class="p">:</span>
            <span class="n">all_touched</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">zonal_stats</span><span class="p">(</span><span class="n">flbuffers_pr</span><span class="p">,</span>
                              <span class="n">demfile</span><span class="p">,</span>
                              <span class="n">stats</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;percentile_1&#39;</span><span class="p">,</span> <span class="s1">&#39;percentile_10&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;percentile_20&#39;</span><span class="p">,</span> <span class="s1">&#39;percentile_80&#39;</span><span class="p">],</span>
                              <span class="n">all_touched</span><span class="o">=</span><span class="n">all_touched</span><span class="p">)</span>
        <span class="c1">#results = {&#39;mean&#39;: np.zeros(len(fl)),</span>
        <span class="c1">#           &#39;min&#39;: np.zeros(len(fl)),</span>
        <span class="c1">#           &#39;percentile_10&#39;: np.zeros(len(fl)),</span>
        <span class="c1">#           &#39;percentile_20&#39;: np.zeros(len(fl)),</span>
        <span class="c1">#           &#39;percentile_80&#39;: np.zeros(len(fl))}</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="c1"># warn if there are more than 10% nan values</span>
        <span class="n">n_nan</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">pct_nan</span> <span class="o">=</span> <span class="n">n_nan</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pct_nan</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Warning: </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:.1%}</span><span class="s2">) of sampled DEM values are NaNs. &quot;</span>
                        <span class="s2">&quot;Check the extent and resolution of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_nan</span><span class="p">,</span> <span class="n">pct_nan</span><span class="p">,</span> <span class="n">demfile</span><span class="p">))</span>

        <span class="n">dem_units_to_output_units</span> <span class="o">=</span> <span class="n">convert_length_units</span><span class="p">(</span><span class="n">dem_length_units</span><span class="p">,</span> <span class="n">output_length_units</span><span class="p">)</span>
        <span class="n">fl</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">dem_units_to_output_units</span>
        <span class="n">fl</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">dem_units_to_output_units</span>
        <span class="n">fl</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">dem_units_to_output_units</span>
        <span class="n">fl</span><span class="p">[</span><span class="s1">&#39;pct01&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">percentile_1</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">dem_units_to_output_units</span>
        <span class="n">fl</span><span class="p">[</span><span class="s1">&#39;pct10&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">percentile_10</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">dem_units_to_output_units</span>
        <span class="n">fl</span><span class="p">[</span><span class="s1">&#39;pct20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">percentile_20</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">dem_units_to_output_units</span>
        <span class="n">fl</span><span class="p">[</span><span class="s1">&#39;pct80&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">percentile_80</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">dem_units_to_output_units</span>
        <span class="n">fl</span><span class="p">[</span><span class="s1">&#39;buffpoly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flbuffers</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Creating buffers and running zonal statistics&#39;</span><span class="p">)</span>

        <span class="c1"># write a shapefile of the flowline buffers for GIS visualization</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;Writing shapefile of buffers used to determine distributary routing...&#39;</span><span class="p">)</span>
        <span class="n">flccb</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">flccb</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flccb</span><span class="o">.</span><span class="n">buffpoly</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="s1">&#39;flowlines_</span><span class="si">{}</span><span class="s1">buffers.shp&#39;</span>
        <span class="k">if</span> <span class="n">asum_thresh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;gt</span><span class="si">{</span><span class="n">asum_thresh</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">km_&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">df2shp</span><span class="p">(</span><span class="n">flccb</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;buffpoly&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
               <span class="n">outfolder</span> <span class="o">/</span> <span class="n">outfile</span><span class="p">,</span>
               <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">dest_crs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">flowline_elevations_file</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;If run_zonal_statistics=False a flowline_elevations_file produced by&quot;</span>
                <span class="s2">&quot;a previous run of the sfrmaker.preprocessing.preprocess_nhdplus() &quot;</span>
                <span class="s2">&quot;function is needed.&quot;</span><span class="p">)</span>
        <span class="n">flccb</span> <span class="o">=</span> <span class="n">shp2df</span><span class="p">(</span><span class="n">flowline_elevations_file</span><span class="p">)</span>
        <span class="n">flccb</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">flccb</span><span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">]</span>
        <span class="n">flccb</span><span class="p">[</span><span class="s1">&#39;buffpoly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flccb</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
        <span class="n">merge_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">flccb</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fl</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flccb</span><span class="p">[</span><span class="n">merge_cols</span><span class="p">])</span>

    <span class="c1"># cull COMIDS with invalid values</span>
    <span class="n">minelev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;Culling COMIDs with smoothed values &lt; </span><span class="si">{}</span><span class="s1"> cm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">minelev</span><span class="p">))</span>
    <span class="n">badstrtop</span> <span class="o">=</span> <span class="p">(</span><span class="n">elevslope</span><span class="o">.</span><span class="n">MAXELEVSMO</span> <span class="o">&lt;</span> <span class="n">minelev</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">elevslope</span><span class="o">.</span><span class="n">MINELEVSMO</span> <span class="o">&lt;</span> <span class="n">minelev</span><span class="p">)</span>
    <span class="n">badstrtop_comids</span> <span class="o">=</span> <span class="n">elevslope</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">badstrtop</span><span class="p">]</span><span class="o">.</span><span class="n">COMID</span><span class="o">.</span><span class="n">values</span>
    <span class="n">badstrtop</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">badstrtop_comids</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">fl</span><span class="o">.</span><span class="n">COMID</span><span class="p">]</span>
    <span class="n">flcc</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">badstrtop</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># add some attributes from pfvaa file</span>
    <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;Divergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfvaa</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">flcc</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Divergence&#39;</span><span class="p">]</span>
    <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;LevelPathI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfvaa</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">flcc</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;LevelPathI&#39;</span><span class="p">]</span>
    <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;nhd_asum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfvaa</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">flcc</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;ArbolateSu&#39;</span><span class="p">]</span>

    <span class="c1"># dictionary with routing info by COMID</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">(</span><span class="n">pf</span><span class="o">.</span><span class="n">FROMCOMID</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">pf</span><span class="o">.</span><span class="n">TOCOMID</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">in_model</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">COMID</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">in_model</span><span class="p">}</span>

    <span class="c1"># use the 10th percentile from zonal_statistics for setting end elevation of each flowline</span>
    <span class="c1"># (hopefully distinguishes flowlines that run along channels vs.</span>
    <span class="c1"># those perpendicular to channels that route across upland areas)</span>
    <span class="n">elevcol</span> <span class="o">=</span> <span class="s1">&#39;pct10&#39;</span>

    <span class="c1"># use zonal statistics elevation to determine routing at divergences</span>
    <span class="c1"># (many of these do not appear to be coded correctly in NHDPlus)</span>
    <span class="c1"># route to the segment with the lowest 20th percentile elevation</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Determining routing at divergences using elevations sampled from </span><span class="si">{</span><span class="n">demfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;Primary distributary determined from lowest </span><span class="si">{}</span><span class="s1">th percentile &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elevcol</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span> <span class="o">+</span>\
          <span class="s1">&#39;elevation value among distributaries at the confluence.</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="c1"># ensure these connections between comids</span>
    <span class="c1"># fromcomid: tocomid</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;Pre-determined routing at divergences (known_connections):</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">known_connections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">txt</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> --&gt; </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

    <span class="c1"># logger statement if no elevations are available and</span>
    <span class="c1"># there is no downstream COMID with Divergence == 1</span>
    <span class="n">no_main_stem_warning</span> <span class="o">=</span> <span class="s1">&#39;warning: no distributaries downstream of COMID </span><span class="si">{}</span><span class="s1"> &#39;</span>
    <span class="n">no_main_stem_warning</span> <span class="o">+=</span> <span class="s1">&#39;with Divergence == 1. Picking the first one: </span><span class="si">{}</span><span class="s1">&#39;</span>

    <span class="c1"># dictionary of values for selecting main channel at diversions</span>
    <span class="n">valid_comids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">flcc</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">div_elevs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">flcc</span><span class="o">.</span><span class="n">COMID</span><span class="p">,</span> <span class="n">flcc</span><span class="p">[</span><span class="n">elevcol</span><span class="p">]))</span>
    <span class="n">tocomids</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">diversionminorcomids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="c1"># limit distributaries to those still in the dataset</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">valid_comids</span><span class="p">)</span>

        <span class="c1"># known connections have to be handled first</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">known_connections</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># primary dist.</span>
            <span class="n">tocomids</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">known_connections</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="c1"># update minorcomids with minor distribs.</span>
            <span class="n">diversionminorcomids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">difference</span><span class="p">({</span><span class="n">tocomids</span><span class="p">[</span><span class="n">k</span><span class="p">]}))</span>
        <span class="c1"># comid routes to only one comid</span>
        <span class="c1"># (likely most common case)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tocomids</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="c1"># comid is an outlet</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tocomids</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># comid routes to multiple comids (diversion)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># downstream elevations</span>
            <span class="n">tocomids_c</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">dnelevs</span> <span class="o">=</span> <span class="p">[</span><span class="n">div_elevs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">toid</span><span class="p">,</span> <span class="mi">99999</span><span class="p">)</span> <span class="k">for</span> <span class="n">toid</span> <span class="ow">in</span> <span class="n">tocomids_c</span><span class="p">]</span>
            <span class="c1"># downstream elevations unique to 2 decimal places</span>
            <span class="n">unique_dnelevs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">dnelevs</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="c1"># primary distributary</span>
            <span class="c1"># if any of the downstream values are nans, or they are all the same</span>
            <span class="c1"># keep the NHD main channel</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dnelevs</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_dnelevs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Divergence == 1 is the main stemp, Divergence == 2 is minor</span>
                <span class="c1"># (see NHDPlus v2 User&#39;s Guide)</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">flcc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tocomids_c</span><span class="p">,</span> <span class="s1">&#39;Divergence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>
                <span class="n">selected_tocomid</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="n">no_main_stem_warning</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">selected_tocomid</span><span class="p">))</span>
                <span class="n">tocomids</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_tocomid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tocomids</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tocomids_c</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">dnelevs</span><span class="p">)]</span>
            <span class="c1"># secondary distributaries</span>
            <span class="n">diversionminorcomids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">difference</span><span class="p">({</span><span class="n">tocomids</span><span class="p">[</span><span class="n">k</span><span class="p">]}))</span>

    <span class="c1"># update the routing graphs</span>
    <span class="c1"># set tocomids to zero if there&#39;s no flowline</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">flcc</span><span class="o">.</span><span class="n">index</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tocomids</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">graph_r</span> <span class="o">=</span> <span class="n">make_graph</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="nb">list</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;tocomid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">flcc</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

    <span class="c1"># drop comids not in the model</span>
    <span class="n">diversionminorcomids</span> <span class="o">=</span> <span class="n">diversionminorcomids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">flcc</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="c1"># drop comids that are routed to</span>
    <span class="c1"># (aren&#39;t minor distributaries if they have another trib routing to them)</span>
    <span class="n">diversionminorcomids</span> <span class="o">=</span> <span class="n">diversionminorcomids</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">flcc</span><span class="o">.</span><span class="n">tocomid</span><span class="p">)</span>

    <span class="c1"># label secondary distributaries</span>
    <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;main_chan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">flcc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">diversionminorcomids</span><span class="p">),</span> <span class="s1">&#39;main_chan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># verify that all comids only route to one other comid</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tocomids</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Determining routing at divergences using elevations sampled from the dem&#39;</span><span class="p">)</span>

    <span class="c1"># Update comid start values using new routing</span>

    <span class="c1"># use the 1st percentile elevation values to avoid outliers</span>
    <span class="c1"># (spurious values in the DEM)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Updating elevation values with 1st percentile sampled from the dem&#39;</span><span class="p">)</span>
    <span class="n">elevs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">flcc</span><span class="o">.</span><span class="n">COMID</span><span class="p">,</span> <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;pct01&#39;</span><span class="p">]))</span>
    
    <span class="c1"># update the elevations with any specified elevations</span>
    <span class="c1"># for up elevations, update the elevations of the next lines upstream</span>
    <span class="k">if</span> <span class="n">update_up_elevations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">comid</span><span class="p">,</span> <span class="n">elev</span> <span class="ow">in</span> <span class="n">update_up_elevations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">fromcomids</span> <span class="o">=</span> <span class="n">graph_r</span><span class="p">[</span><span class="n">comid</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">comid</span> <span class="ow">in</span> <span class="n">fromcomids</span><span class="p">:</span>
                <span class="n">elevs</span><span class="p">[</span><span class="n">comid</span><span class="p">]</span> <span class="o">=</span> <span class="n">elev</span>
            <span class="c1"># ensure that there aren&#39;t any lower elevations upstream</span>
            <span class="n">all_upstream_comids</span> <span class="o">=</span> <span class="n">get_upsegs</span><span class="p">(</span><span class="n">graph_r</span><span class="p">,</span> <span class="n">comid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">comid</span> <span class="ow">in</span> <span class="n">all_upstream_comids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">elevs</span><span class="p">[</span><span class="n">comid</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">elev</span><span class="p">:</span>
                    <span class="n">elevs</span><span class="p">[</span><span class="n">comid</span><span class="p">]</span> <span class="o">=</span> <span class="n">elev</span>
    <span class="c1"># for dn elevations, update the elevation for that line</span>
    <span class="k">if</span> <span class="n">update_dn_elevations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">comid</span><span class="p">,</span> <span class="n">elev</span> <span class="ow">in</span> <span class="n">update_dn_elevations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">elevs</span><span class="p">[</span><span class="n">comid</span><span class="p">]</span> <span class="o">=</span> <span class="n">elev</span>
            <span class="c1"># ensure that there aren&#39;t any lower elevations upstream</span>
            <span class="c1"># include any co-tributaries</span>
            <span class="n">tocomid</span> <span class="o">=</span> <span class="n">flcc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid</span><span class="p">,</span> <span class="s1">&#39;tocomid&#39;</span><span class="p">]</span>
            <span class="n">cotribs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">flcc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;tocomid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tocomid</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">all_upstream_comids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">comid</span> <span class="ow">in</span> <span class="n">cotribs</span><span class="p">:</span>
                <span class="n">elevs</span><span class="p">[</span><span class="n">comid</span><span class="p">]</span> <span class="o">=</span> <span class="n">elev</span>
                <span class="n">cotribs_upstream_comids</span> <span class="o">=</span> <span class="n">get_upsegs</span><span class="p">(</span><span class="n">graph_r</span><span class="p">,</span> <span class="n">comid</span><span class="p">)</span>
                <span class="n">all_upstream_comids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cotribs_upstream_comids</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">comid</span> <span class="ow">in</span> <span class="n">all_upstream_comids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">elevs</span><span class="p">[</span><span class="n">comid</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">elev</span><span class="p">:</span>
                    <span class="n">elevs</span><span class="p">[</span><span class="n">comid</span><span class="p">]</span> <span class="o">=</span> <span class="n">elev</span>
                
    <span class="n">elevup</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cm_to_output_units</span> <span class="o">=</span> <span class="n">convert_length_units</span><span class="p">(</span><span class="s1">&#39;cm&#39;</span><span class="p">,</span> <span class="n">output_length_units</span><span class="p">)</span>
    <span class="c1"># dictionary of NHDPlus minimum values converted to output units</span>
    <span class="n">elevslope_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">elevslope</span><span class="o">.</span><span class="n">COMID</span><span class="p">,</span> <span class="n">elevslope</span><span class="o">.</span><span class="n">MINELEVSMO</span> <span class="o">*</span> <span class="n">cm_to_output_units</span><span class="p">))</span>
    <span class="c1"># screen for comids outside model</span>
    <span class="n">valid_comids</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">elevs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">minelev</span> <span class="o">&lt;</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mf">1e5</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">tocomid</span><span class="p">,</span> <span class="n">fromcomids</span> <span class="ow">in</span> <span class="n">graph_r</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># if len(fromcomids) &gt; 0:</span>
        <span class="n">fromcomids</span> <span class="o">=</span> <span class="n">fromcomids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">valid_comids</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fromcomids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">elevup</span><span class="p">[</span><span class="n">tocomid</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">elevs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">fromcomids</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">tocomid</span> <span class="ow">in</span> <span class="n">valid_comids</span><span class="p">:</span>
            <span class="n">elevup</span><span class="p">[</span><span class="n">tocomid</span><span class="p">]</span> <span class="o">=</span> <span class="n">elevs</span><span class="p">[</span><span class="n">tocomid</span><span class="p">]</span>

    <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;elevup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">elevup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">flcc</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;elevdn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">elevs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">if</span> <span class="o">-</span><span class="mi">10</span> <span class="o">&lt;</span> <span class="n">elevs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e5</span> <span class="k">else</span> <span class="n">elevslope_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">flcc</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="n">noelevup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">flcc</span><span class="o">.</span><span class="n">elevup</span><span class="p">)</span>
    <span class="n">flcc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">noelevup</span><span class="p">,</span> <span class="s1">&#39;elevup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flcc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">noelevup</span><span class="p">,</span> <span class="s1">&#39;elevdn&#39;</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Updating elevation values with 1st percentile sampled from the dem&#39;</span><span class="p">)</span>


    <span class="c1"># smooth segment end values so that they never rise downstream</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Smoothing updated elevations&#39;</span><span class="p">)</span>
    <span class="n">elevminsmo</span><span class="p">,</span> <span class="n">elevmaxsmo</span> <span class="o">=</span> <span class="n">smooth_elevations</span><span class="p">(</span><span class="n">flcc</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">flcc</span><span class="o">.</span><span class="n">tocomid</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                               <span class="n">flcc</span><span class="o">.</span><span class="n">elevdn</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">flcc</span><span class="o">.</span><span class="n">elevup</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;elevupsmo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">elevmaxsmo</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">flcc</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;elevdnsmo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">elevminsmo</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">flcc</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

    <span class="c1"># verify that end values less than start values</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">flcc</span><span class="o">.</span><span class="n">elevdnsmo</span> <span class="o">&lt;=</span> <span class="n">flcc</span><span class="o">.</span><span class="n">elevupsmo</span><span class="p">)</span>
    <span class="c1"># verify that values don&#39;t rise at segment connections</span>
    <span class="n">elevupsmo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">flcc</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">flcc</span><span class="o">.</span><span class="n">elevupsmo</span><span class="p">))</span>
    <span class="n">nextup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">elevupsmo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">),</span> <span class="o">-</span><span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">flcc</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">nextup</span> <span class="o">&lt;=</span> <span class="n">flcc</span><span class="o">.</span><span class="n">elevdnsmo</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Smoothing updated elevations&#39;</span><span class="p">)</span>

    <span class="c1"># subtract secondary distributaries</span>
    <span class="n">nhdplus_asums</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">pfvaa</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pfvaa</span><span class="o">.</span><span class="n">ArbolateSu</span><span class="p">))</span>
    <span class="n">fl_lengths</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">LENGTHKM</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Recomputing arbolate sums&#39;</span><span class="p">)</span>
    <span class="c1"># NHDPlus asums are the default</span>
    <span class="n">asum_calc</span> <span class="o">=</span> <span class="n">nhdplus_asums</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># recompute the arbolate sums so that minor distributaries start at 0</span>
    <span class="c1"># only recompute at minor distributaries because of missing lines (that have already been culled)</span>
    <span class="c1"># also issues with double-counting asums from distributaries along the model edge</span>
    <span class="n">new_minor_distrib_asums</span> <span class="o">=</span> <span class="n">recompute_asums_for_minor_distribs</span><span class="p">(</span><span class="n">diversionminorcomids</span><span class="p">,</span>
                                                                 <span class="n">fl_lengths</span><span class="p">,</span>
                                                                 <span class="n">graph</span><span class="p">,</span> <span class="n">graph_r</span><span class="p">)</span>
    <span class="n">asum_calc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_minor_distrib_asums</span><span class="p">)</span>
    <span class="c1"># recompute arbolate sums at and downstream of places where it decreases</span>
    <span class="c1"># decreases are caused by routing connections that were not in NHDPlus</span>
    <span class="n">fixed_invalid_asums</span> <span class="o">=</span> <span class="n">fix_invalid_asums</span><span class="p">(</span><span class="n">asum_calc</span><span class="p">,</span> <span class="n">fl_lengths</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">graph_r</span><span class="p">)</span>
    <span class="n">asum_calc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fixed_invalid_asums</span><span class="p">)</span>
    <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;asum_calc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">asum_calc</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">flcc</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Recomputing arbolate sums&#39;</span><span class="p">)</span>

    <span class="c1"># cull flow paths below minor distributaries</span>
    <span class="c1"># until they reach the arbolate sum threshold</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;Culling minor distributary flowlines &lt; </span><span class="si">{}</span><span class="s1"> km from divergence...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">asum_thresh</span><span class="p">))</span>
    <span class="n">to_drop</span> <span class="o">=</span> <span class="n">flcc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">flcc</span><span class="o">.</span><span class="n">asum_calc</span> <span class="o">&lt;</span> <span class="n">asum_thresh</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">index</span>
    <span class="n">flcc</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">to_drop</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;asum_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flcc</span><span class="o">.</span><span class="n">nhd_asum</span> <span class="o">-</span> <span class="n">flcc</span><span class="o">.</span><span class="n">asum_calc</span>

    <span class="c1"># estimate channel width using arbolate sum relationship</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;Populating channel widths...&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;width = </span><span class="si">{}</span><span class="s1"> * arbolate sum (meters) ^ </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">width_from_asum_a_param</span><span class="p">,</span>
                                                                      <span class="n">width_from_asum_b_param</span><span class="p">))</span>
    <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;width1asum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">width_from_arbolate_sum</span><span class="p">(</span><span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;asum_calc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;LENGTHKM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                 <span class="n">a</span><span class="o">=</span><span class="n">width_from_asum_a_param</span><span class="p">,</span>
                                                 <span class="n">b</span><span class="o">=</span><span class="n">width_from_asum_b_param</span><span class="p">,</span>
                                                 <span class="n">minimum_width</span><span class="o">=</span><span class="n">minimum_width</span><span class="p">,</span>
                                                 <span class="n">input_units</span><span class="o">=</span><span class="s1">&#39;km&#39;</span><span class="p">,</span> <span class="n">output_units</span><span class="o">=</span><span class="n">output_length_units</span><span class="p">)</span>
    <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;width2asum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">width_from_arbolate_sum</span><span class="p">(</span><span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;asum_calc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                 <span class="n">a</span><span class="o">=</span><span class="n">width_from_asum_a_param</span><span class="p">,</span>
                                                 <span class="n">b</span><span class="o">=</span><span class="n">width_from_asum_b_param</span><span class="p">,</span>
                                                 <span class="n">minimum_width</span><span class="o">=</span><span class="n">minimum_width</span><span class="p">,</span>
                                                 <span class="n">input_units</span><span class="o">=</span><span class="s1">&#39;km&#39;</span><span class="p">,</span> <span class="n">output_units</span><span class="o">=</span><span class="n">output_length_units</span><span class="p">)</span>
    <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;width1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flcc</span><span class="o">.</span><span class="n">width1asum</span>
    <span class="n">flcc</span><span class="p">[</span><span class="s1">&#39;width2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flcc</span><span class="o">.</span><span class="n">width2asum</span>
    <span class="k">if</span> <span class="n">narwidth_shapefile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">narwidth_shapefile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;narwidth_shapefile: </span><span class="si">{}</span><span class="s2"> not found!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">narwidth_shapefile</span><span class="p">))</span>
        <span class="c1"># sample widths for wider streams from NARWidth</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Sampling widths from NARWidth database&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log_package_version</span><span class="p">(</span><span class="s1">&#39;rtree&#39;</span><span class="p">)</span>
        <span class="n">narwidth_crs</span> <span class="o">=</span> <span class="n">get_crs</span><span class="p">(</span><span class="n">narwidth_shapefile</span><span class="p">)</span>
        <span class="n">narwidth_bbox</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">flowline_bbox</span><span class="p">,</span> <span class="n">flowline_crs</span><span class="p">,</span> <span class="n">narwidth_crs</span><span class="p">)</span>
        <span class="n">sample_NARWidth</span><span class="p">(</span><span class="n">flcc</span><span class="p">,</span> <span class="n">narwidth_shapefile</span><span class="p">,</span>
                        <span class="n">waterbodies</span><span class="o">=</span><span class="n">waterbody_shapefiles</span><span class="p">,</span>
                        <span class="n">bbox_filter</span><span class="o">=</span><span class="n">narwidth_bbox</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
                        <span class="n">crs</span><span class="o">=</span><span class="n">project_crs</span><span class="p">,</span>
                        <span class="n">output_width_units</span><span class="o">=</span><span class="n">output_length_units</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Sampling widths from NARWidth database&#39;</span><span class="p">)</span>

        <span class="n">frac_narwidth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">flcc</span><span class="o">.</span><span class="n">narwd_mean</span><span class="p">))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">flcc</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;Flowline widths estimated from arbolate sum: </span><span class="si">{0:.1%}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">frac_narwidth</span><span class="p">),</span> <span class="n">log_time</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;Flowline widths sampled from NARWidth: </span><span class="si">{0:.1%}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frac_narwidth</span><span class="p">),</span> <span class="n">log_time</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">flcc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">flcc</span><span class="o">.</span><span class="n">narwd_mean</span><span class="p">),</span> <span class="s1">&#39;width1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flcc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">flcc</span><span class="o">.</span><span class="n">narwd_mean</span><span class="p">),</span> <span class="s1">&#39;narwd_mean&#39;</span><span class="p">]</span>
        <span class="n">flcc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">flcc</span><span class="o">.</span><span class="n">narwd_mean</span><span class="p">),</span> <span class="s1">&#39;width2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flcc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">flcc</span><span class="o">.</span><span class="n">narwd_mean</span><span class="p">),</span> <span class="s1">&#39;narwd_mean&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">active_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flcc</span> <span class="o">=</span> <span class="n">clip_flowlines_to_polygon</span><span class="p">(</span><span class="n">flcc</span><span class="p">,</span> <span class="n">active_area</span><span class="p">,</span>
                                         <span class="n">crs</span><span class="o">=</span><span class="n">dest_crs</span><span class="p">,</span>
                                         <span class="n">simplify_tol</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        
    <span class="c1"># write output files; record timestamps in logger</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;writing output&#39;</span><span class="p">)</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="s1">&#39;preprocessed_flowlines</span><span class="si">{}</span><span class="s1">.shp&#39;</span>
    <span class="k">if</span> <span class="n">asum_thresh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_gt</span><span class="si">{</span><span class="n">asum_thresh</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">km&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">df2shp</span><span class="p">(</span><span class="n">flcc</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;buffpoly&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">outfolder</span> <span class="o">/</span> <span class="n">outfile</span><span class="p">,</span>
           <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">dest_crs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Preprocessing Flowlines&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">flcc</span></div>



<div class="viewcode-block" id="clip_flowlines_to_polygon">
<a class="viewcode-back" href="../../api/sfrmaker.preprocessing.html#sfrmaker.preprocessing.clip_flowlines_to_polygon">[docs]</a>
<span class="k">def</span> <span class="nf">clip_flowlines_to_polygon</span><span class="p">(</span><span class="n">flowlines</span><span class="p">,</span> <span class="n">polygon</span><span class="p">,</span>
                              <span class="n">crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">simplify_tol</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clip line features in a flowlines DataFrame to polygon</span>
<span class="sd">    features in polygon.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    flowlines : DataFrame</span>
<span class="sd">        Output from :func:`~sfrmaker.preprocessing.preprocess_nhdplus`</span>
<span class="sd">    crs : obj</span>
<span class="sd">        Coordinate reference system of flowlines. Only needed if</span>
<span class="sd">        the data do not have a valid ESRI projection (.prj) file.</span>
<span class="sd">        A Python int, dict, str, or :class:`pyproj.crs.CRS` instance</span>
<span class="sd">        passed to :meth:`pyproj.crs.CRS.from_user_input`</span>

<span class="sd">        Can be any of:</span>
<span class="sd">          - PROJ string</span>
<span class="sd">          - Dictionary of PROJ parameters</span>
<span class="sd">          - PROJ keyword arguments for parameters</span>
<span class="sd">          - JSON string with PROJ parameters</span>
<span class="sd">          - CRS WKT string</span>
<span class="sd">          - An authority string [i.e. &#39;epsg:4326&#39;]</span>
<span class="sd">          - An EPSG integer code [i.e. 4326]</span>
<span class="sd">          - A tuple of (&quot;auth_name&quot;: &quot;auth_code&quot;) [i.e (&#39;epsg&#39;, &#39;4326&#39;)]</span>
<span class="sd">          - An object with a `to_wkt` method.</span>
<span class="sd">          - A :class:`pyproj.crs.CRS` class</span>

<span class="sd">        By default, None</span>
<span class="sd">    polygon : str</span>
<span class="sd">        Polygon shapefile, shapely polygon or list of shapely polygons of model active area. Shapely polygons </span>
<span class="sd">        must be in the same CRS as flowlines; shapefiles will be automatically reprojected.</span>
<span class="sd">    simplify_tol : float</span>
<span class="sd">        Simplification tolerance for ``polygon`` to speed clipping.</span>
<span class="sd">        See :doc:`shapely:manual` for more details.</span>
<span class="sd">    logger : Logger instance</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flc : clipped flowlines dataframe</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>

    <span class="c1"># read in the active area and to_crs to same crs as flowlines</span>
    <span class="n">flowlines_crs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flowlines_crs</span> <span class="o">=</span> <span class="n">get_crs</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flowlines</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">):</span>
        <span class="n">flowlines_crs</span> <span class="o">=</span> <span class="n">flowlines</span><span class="o">.</span><span class="n">crs</span>
        
    <span class="n">active_area_polygon</span> <span class="o">=</span> <span class="n">read_polygon_feature</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">flowlines_crs</span><span class="p">)</span>

    <span class="c1"># simplify polygon vertices to speed intersection testing</span>
    <span class="c1"># (can be very slow for polygons generated from rasters)</span>
    <span class="n">active_area_polygon</span> <span class="o">=</span> <span class="n">active_area_polygon</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">simplify_tol</span><span class="p">)</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">simplify_tol</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Culling flowlines outside of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polygon</span><span class="p">))</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">flowlines</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;starting lines: </span><span class="si">{:,d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)))</span>
    <span class="n">intersects</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">active_area_polygon</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="n">flc</span> <span class="o">=</span> <span class="n">flowlines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">intersects</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">flc</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">active_area_polygon</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">flc</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>
    <span class="n">drop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">g</span><span class="o">.</span><span class="n">is_empty</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">flc</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">flc</span> <span class="o">=</span> <span class="n">flc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">drop</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;remaining lines: </span><span class="si">{:,d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flc</span><span class="p">)))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Culling flowlines outside of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polygon</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">flc</span></div>



<div class="viewcode-block" id="sample_NARWidth">
<a class="viewcode-back" href="../../api/sfrmaker.preprocessing.html#sfrmaker.preprocessing.sample_NARWidth">[docs]</a>
<span class="k">def</span> <span class="nf">sample_NARWidth</span><span class="p">(</span><span class="n">flowlines</span><span class="p">,</span> <span class="n">narwidth_shapefile</span><span class="p">,</span> <span class="n">waterbodies</span><span class="p">,</span>
                    <span class="n">bbox_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">output_width_units</span><span class="o">=</span><span class="s1">&#39;meters&#39;</span><span class="p">,</span>
                    <span class="n">outpath</span><span class="o">=</span><span class="s1">&#39;shps/&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sample the North American River Width Database by</span>
<span class="sd">    doing a spatial join (transfer width information from</span>
<span class="sd">    NARWidth shapefile to flowlines shapefile based on proximity).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    flowlines : DataFrame</span>
<span class="sd">        flowlines dataframe from preprocess_nhdplus().</span>
<span class="sd">        Flowlines must be in a projected Coordinate reference system (CRS).</span>
<span class="sd">    narwidth_shapefile : str</span>
<span class="sd">        Path to shapefile from the NARWidth database (Allen and Pavelsky, 2015).</span>
<span class="sd">    waterbody_shapefiles : str or list of strings, optional</span>
<span class="sd">        Path(s) to NHDPlus NHDWaterbody shapefile(s). Only required if a</span>
<span class="sd">        ``narwidth_shapefile`` is specified.</span>
<span class="sd">    crs : obj</span>
<span class="sd">        Coordinate reference system of flowlines.</span>
<span class="sd">        A Python int, dict, str, or :class:`pyproj.crs.CRS` instance</span>
<span class="sd">        passed to :meth:`pyproj.crs.CRS.from_user_input`</span>

<span class="sd">        Can be any of:</span>
<span class="sd">          - PROJ string</span>
<span class="sd">          - Dictionary of PROJ parameters</span>
<span class="sd">          - PROJ keyword arguments for parameters</span>
<span class="sd">          - JSON string with PROJ parameters</span>
<span class="sd">          - CRS WKT string</span>
<span class="sd">          - An authority string [i.e. &#39;epsg:4326&#39;]</span>
<span class="sd">          - An EPSG integer code [i.e. 4326]</span>
<span class="sd">          - A tuple of (&quot;auth_name&quot;: &quot;auth_code&quot;) [i.e (&#39;epsg&#39;, &#39;4326&#39;)]</span>
<span class="sd">          - An object with a `to_wkt` method.</span>
<span class="sd">          - A :class:`pyproj.crs.CRS` class</span>

<span class="sd">        By default, None</span>
<span class="sd">    filter : tuple</span>
<span class="sd">        Bounds (most likely in lat/lon) for filtering NARWidth lines that are read in</span>
<span class="sd">        (left, bottom, right, top)</span>
<span class="sd">    output_width_units : str, any length unit; e.g. {&#39;m&#39;, &#39;meters&#39;, &#39;ft&#39;, etc.}</span>
<span class="sd">        Units for width and elevation attribute values included with the output flowlines.</span>
<span class="sd">        NARWidth widths are assumed to be in meters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    This function operates on the fl DataFrame in place.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    To avoid erroneous overlap between main-stem NARWidth estimates and minor tributaries, flowlines with arbolate sums less than 500 km only receive widths from NARWidth lines that have at least 50% of their length inside of the 1-km buffer. NARWidth values are generally higher than arbolate sum-based estimates, because the NARWidth estimates represent mean flows and include all reaches of the stream, whereas the arbolate sum estimates are based on field measurements taken at narrower than average, well-behaved channel sections near stream gages, under base flow conditions. Therefore, measured channel widths may be biased low compared to actual widths throughout the stream network (Allen and Pavelsky, 2015; Park, 1977).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">wb</span> <span class="o">=</span> <span class="n">shp2df</span><span class="p">(</span><span class="n">waterbodies</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outpath</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span>

    <span class="n">flowline_crs</span> <span class="o">=</span> <span class="n">get_crs</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flowline_crs</span><span class="o">.</span><span class="n">is_geographic</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Flowlines must be in a projected Coordinate Reference System &quot;</span>
               <span class="s2">&quot;(CRS; i.e. with units of meters).&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># read in narwidth shapefile; to_crs to flowline CRS</span>
    <span class="n">nw</span> <span class="o">=</span> <span class="n">shp2df</span><span class="p">(</span><span class="n">narwidth_shapefile</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">bbox_filter</span><span class="p">)</span>
    <span class="n">narwidth_crs</span> <span class="o">=</span> <span class="n">get_shapefile_crs</span><span class="p">(</span><span class="n">narwidth_shapefile</span><span class="p">)</span>
    <span class="n">nw</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">narwidth_crs</span><span class="p">,</span> <span class="n">flowline_crs</span><span class="p">)</span>

    <span class="c1"># draw buffers around flowlines</span>
    <span class="n">buffdist</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># m</span>
    <span class="n">buffers</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffdist</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">flowlines</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>
    <span class="n">flbuff</span> <span class="o">=</span> <span class="n">flowlines</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">flbuff</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffers</span>
    <span class="n">df2shp</span><span class="p">(</span><span class="n">flbuff</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/flowlines_edited_buffers_</span><span class="si">{}</span><span class="s1">.shp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">buffdist</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="n">flowline_crs</span><span class="p">)</span>

    <span class="c1"># determine which narwidth segments intersect the flowline buffers</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">intersect_rtree</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">flbuff</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

    <span class="c1"># weed out tribs that might have picked up narwidths for main stem</span>
    <span class="n">asum_thresh</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># threshold for evaluating whether flowline is a minor distributary</span>
    <span class="c1"># (will have small calculated asum)</span>
    <span class="n">overlap_thresh</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># require lines with small calculated asum to be at least 50% with buffered NARWidth points</span>

    <span class="c1"># compile statistics on sampled narwidths</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">widths_mean</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">widths_std</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">widths_min</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">widths_max</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="n">fl_info</span> <span class="o">=</span> <span class="n">flowlines</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># if the calculated asum is less than the threshold</span>
        <span class="c1"># do another test to see how much overlap there is</span>
        <span class="c1"># between flowling and narwidth</span>
        <span class="c1"># goal is to prevent small tribs or distribs from being assigned huge widths</span>
        <span class="n">append_narwidth</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fl_info</span><span class="p">[</span><span class="s1">&#39;asum_calc&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">asum_thresh</span><span class="p">:</span>
                <span class="n">narwidth_line_buffered</span> <span class="o">=</span> <span class="n">MultiLineString</span><span class="p">(</span><span class="n">nw</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">buffdist</span><span class="p">)</span>
                <span class="n">fl_g</span> <span class="o">=</span> <span class="n">fl_info</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
                <span class="n">fl_overlap</span> <span class="o">=</span> <span class="n">fl_g</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">narwidth_line_buffered</span><span class="p">)</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="n">fl_g</span><span class="o">.</span><span class="n">length</span>
                <span class="k">if</span> <span class="n">fl_overlap</span> <span class="o">&gt;</span> <span class="n">overlap_thresh</span><span class="p">:</span>
                    <span class="n">append_narwidth</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">append_narwidth</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">append_narwidth</span><span class="p">:</span>
            <span class="n">n</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="n">sampled_widths</span> <span class="o">=</span> <span class="n">nw</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">]</span>  <span class="c1"># convert from meters to feet</span>
            <span class="n">widths_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sampled_widths</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
            <span class="n">widths_std</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sampled_widths</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
            <span class="n">widths_min</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sampled_widths</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
            <span class="n">widths_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sampled_widths</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">widths_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">widths_std</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">widths_min</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">widths_max</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="n">unit_conversion</span> <span class="o">=</span> <span class="n">convert_length_units</span><span class="p">(</span><span class="s1">&#39;meters&#39;</span><span class="p">,</span> <span class="n">output_width_units</span><span class="p">)</span>
    <span class="n">flowlines</span><span class="p">[</span><span class="s1">&#39;narwd_n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
    <span class="n">flowlines</span><span class="p">[</span><span class="s1">&#39;narwd_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">widths_mean</span><span class="p">)</span> <span class="o">*</span> <span class="n">unit_conversion</span>
    <span class="n">flowlines</span><span class="p">[</span><span class="s1">&#39;narwd_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">widths_std</span><span class="p">)</span> <span class="o">*</span> <span class="n">unit_conversion</span>
    <span class="n">flowlines</span><span class="p">[</span><span class="s1">&#39;narwd_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">widths_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">unit_conversion</span>
    <span class="n">flowlines</span><span class="p">[</span><span class="s1">&#39;narwd_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">widths_max</span><span class="p">)</span> <span class="o">*</span> <span class="n">unit_conversion</span>
    <span class="n">waterbodies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">wb</span><span class="o">.</span><span class="n">COMID</span><span class="p">)</span>
    <span class="n">flowlines</span><span class="p">[</span><span class="s1">&#39;is_wb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">waterbodies</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">flowlines</span><span class="o">.</span><span class="n">WBAREACOMI</span><span class="p">]</span>

    <span class="n">flowlines</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/flowlines_w_sampled_narwidth_elevations.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outpath</span><span class="p">))</span>

    <span class="c1"># only apply narwidths to rivers that are listed as waterbodies</span>
    <span class="c1"># or those that aren&#39;t, but have an asum &gt; 500 km, and a sampled value</span>
    <span class="n">rivers_with_widths</span> <span class="o">=</span> <span class="o">~</span><span class="n">flowlines</span><span class="o">.</span><span class="n">is_wb</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">flowlines</span><span class="o">.</span><span class="n">nhd_asum</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">flowlines</span><span class="o">.</span><span class="n">narwd_mean</span><span class="p">)</span>
    <span class="n">wbs</span> <span class="o">=</span> <span class="n">flowlines</span><span class="o">.</span><span class="n">is_wb</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">flowlines</span><span class="o">.</span><span class="n">narwd_mean</span><span class="p">)</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="n">rivers_with_widths</span> <span class="o">|</span> <span class="n">wbs</span>

    <span class="n">df2shp</span><span class="p">(</span><span class="n">flowlines</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">criteria</span><span class="p">,</span> <span class="p">:],</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/flowlines_w_sampled_narwidth_elevations.shp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outpath</span><span class="p">),</span>
           <span class="n">crs</span><span class="o">=</span><span class="n">flowline_crs</span><span class="p">)</span></div>



<div class="viewcode-block" id="edit_flowlines">
<a class="viewcode-back" href="../../api/sfrmaker.preprocessing.html#sfrmaker.preprocessing.edit_flowlines">[docs]</a>
<span class="k">def</span> <span class="nf">edit_flowlines</span><span class="p">(</span><span class="n">flowlines</span><span class="p">,</span> <span class="n">config_file</span><span class="p">,</span>
                   <span class="n">id_column</span><span class="o">=</span><span class="s1">&#39;COMID&#39;</span><span class="p">,</span> <span class="n">toid_column</span><span class="o">=</span><span class="s1">&#39;tocomid&#39;</span><span class="p">,</span>
                   <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make edits to the flowlines in flowlines_file,</span>
<span class="sd">    as described in config_file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    flowlines : shapefile or DataFrame</span>
<span class="sd">        Flowlines to edit. If a shapefile is specified, a backup</span>
<span class="sd">        with &quot;.original&quot; before the extension is made, and the</span>
<span class="sd">        input shapefile is overwritten by the results.</span>
<span class="sd">    config_file : yaml file</span>
<span class="sd">        e.g. &#39;flowline_edits.yml&#39;</span>
<span class="sd">    id_column : str</span>
<span class="sd">        Column in flowlines with unique identifiers (e.g. COMIDs)</span>
<span class="sd">    toid_column : str</span>
<span class="sd">        Column in flowslines with downstream routing connections (identifiers)</span>
<span class="sd">    logger : sfrmaker logger instance, optional</span>
<span class="sd">        Pass a logger file instance to continue writing to an open logger file</span>
<span class="sd">        (e.g. after or before other operations)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flowlines : DataFrame</span>
<span class="sd">        Edited flowlines.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;editing flowlines...&#39;</span><span class="p">)</span>

    <span class="c1"># load the configuration file</span>
    <span class="n">config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">config_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log_file_and_date_modified</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">Loader</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flowlines</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flowlines</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log_file_and_date_modified</span><span class="p">(</span><span class="n">flowlines</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">shp2df</span><span class="p">(</span><span class="n">flowlines</span><span class="p">)</span>
        <span class="c1"># make a backup</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="s1">&#39;.shp&#39;</span><span class="p">,</span> <span class="s1">&#39;.dbf&#39;</span><span class="p">,</span> <span class="s1">&#39;.shx&#39;</span><span class="p">,</span> <span class="s1">&#39;.prj&#39;</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">flowlines</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">ext</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="n">flowlines</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.original&#39;</span> <span class="o">+</span> <span class="n">ext</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
        <span class="n">prj_file</span> <span class="o">=</span> <span class="n">dest</span>  <span class="c1"># for writing a new shapefile at the end</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flowlines</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">flowlines</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid datatype for flowlines input: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">flowlines</span><span class="p">)))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_column</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;add_flowlines&#39;</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
        <span class="n">add_flowlines_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span>
                                          <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;add_flowlines&#39;</span><span class="p">][</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">shp2df</span><span class="p">(</span><span class="n">add_flowlines_file</span><span class="p">)</span>

        <span class="c1"># resolve case differences in column names</span>
        <span class="c1"># conform columns to flowlines</span>
        <span class="n">column_mappings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">lower_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">df2</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c2</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">lower_cols</span><span class="p">:</span>
                <span class="n">column_mappings</span><span class="p">[</span><span class="n">c2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_cols</span><span class="p">[</span><span class="n">c2</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="n">df2</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">column_mappings</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># drop the IDs being added if they already exist</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="n">id_column</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">id_column</span><span class="p">])]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_column</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;added flowlines: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">id_column</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span>
                                                                    <span class="mi">100</span><span class="p">)))</span>
    <span class="n">drop_upids</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;drop_flowlines&#39;</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>

        <span class="n">drop_ids</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;drop_flowlines&#39;</span><span class="p">]</span>
        <span class="n">drop_rows</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">drop_ids</span><span class="p">)</span>
        <span class="n">drop_upids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">drop_rows</span><span class="p">,</span> <span class="n">toid_column</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">drop_rows</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;dropped flowlines: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">drop_upids</span><span class="p">),</span> <span class="mi">100</span><span class="p">)))</span>

    <span class="k">if</span> <span class="s1">&#39;reroute_flowlines&#39;</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;reroute_flowlines&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">toid_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> not in </span><span class="si">{}</span><span class="s2">; can&#39;t re-route to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">flowlines</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;rerouted </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

    <span class="c1"># verify that all to comids besides 0 are in id column</span>
    <span class="c1"># actually apparently don&#39;t have to do this because</span>
    <span class="c1"># there are already many toids not in the preprocessed flowlines</span>
    <span class="c1"># sfrmaker presumably converts them to outlets</span>
    <span class="c1">#notin = set(df[toid_column]).difference(df.index)</span>

    <span class="c1"># write out an updated version of the input flowlines file</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flowlines</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flowlines</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">df2shp</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">flowlines</span><span class="p">,</span> <span class="n">prj</span><span class="o">=</span><span class="n">prj_file</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">statement</span><span class="p">(</span><span class="s1">&#39;wrote </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flowlines</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="recompute_asums_for_minor_distribs">
<a class="viewcode-back" href="../../api/sfrmaker.preprocessing.html#sfrmaker.preprocessing.recompute_asums_for_minor_distribs">[docs]</a>
<span class="k">def</span> <span class="nf">recompute_asums_for_minor_distribs</span><span class="p">(</span><span class="n">minor_distrib_comids</span><span class="p">,</span> <span class="n">fl_lengths</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">graph_r</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reset arbolate sums for minor distributaries and</span>
<span class="sd">    downstream segments in their path, to the next confluence.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    minor_distrib_comids : sequence</span>
<span class="sd">        Sequence of line identifiers for minor distributaries</span>
<span class="sd">        (that were part of a divergence in NHDPlus).</span>
<span class="sd">    fl_lengths : dict</span>
<span class="sd">        Dictionary of flowline lengths {indentifier (e.g. comid): length values},</span>
<span class="sd">        in same units as asums.</span>
<span class="sd">    graph : dict</span>
<span class="sd">        Dictionary of downstream routing connections {fromcomid: tocomid}</span>
<span class="sd">    graph_r : dict</span>
<span class="sd">        Dictionary of upstream routing connections {tocomid: {fromcomid1, fromcomid2,...}}</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_asums : dict</span>
<span class="sd">        Dictionary of recomputed arbolate sums {comid: asum value}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_asums</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">minor_distrib_comids</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">find_path</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">asum_c</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># current asum</span>
        <span class="c1"># for each comid going downstream</span>
        <span class="k">for</span> <span class="n">cp</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">tribs</span> <span class="o">=</span> <span class="n">graph_r</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span>
            <span class="c1"># end condition is an outlet or confluence</span>
            <span class="k">if</span> <span class="n">cp</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">tribs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="c1"># increment the asum by the current length</span>
            <span class="n">asum_c</span> <span class="o">+=</span> <span class="n">fl_lengths</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span>
            <span class="n">new_asums</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span> <span class="o">=</span> <span class="n">asum_c</span>
    <span class="k">return</span> <span class="n">new_asums</span></div>



<div class="viewcode-block" id="fix_invalid_asums">
<a class="viewcode-back" href="../../api/sfrmaker.preprocessing.html#sfrmaker.preprocessing.fix_invalid_asums">[docs]</a>
<span class="k">def</span> <span class="nf">fix_invalid_asums</span><span class="p">(</span><span class="n">asums</span><span class="p">,</span> <span class="n">fl_lengths</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">graph_r</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Recompute arbolate sum at any places in the network</span>
<span class="sd">    where it decreases going downstream, and then for all lines</span>
<span class="sd">    downstream of those locations. Decreases may be caused by</span>
<span class="sd">    routing connections that weren&#39;t in the original NHDPlus data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    asums : dict</span>
<span class="sd">        Dictionary of {indentifier (e.g. comid): asum values},</span>
<span class="sd">        in same units as fl_lengths. Includes all lines in the stream network.</span>
<span class="sd">    fl_lengths : dict</span>
<span class="sd">        Dictionary of flowline lengths {indentifier (e.g. comid): length values},</span>
<span class="sd">        in same units as asums.</span>
<span class="sd">    graph : dict</span>
<span class="sd">        Dictionary of downstream routing connections {fromcomid: tocomid}</span>
<span class="sd">    graph_r : dict</span>
<span class="sd">        Dictionary of upstream routing connections {tocomid: {fromcomid1, fromcomid2,...}}</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_asums : dict</span>
<span class="sd">        Dictionary of recomputed arbolate sums {comid: asum value}</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function is only designed to fix instances of breaks in</span>
<span class="sd">    arbolate sum caused by new routing connections. It can&#39;t fix</span>
<span class="sd">    all instances of invalid asums, because it is not known whether</span>
<span class="sd">    the arbolate sums from upstream tributaries reflect unique upstream</span>
<span class="sd">    drainages (if the tribs are distributaries coming from the same divergence,</span>
<span class="sd">    there asums will reflect the same upstream drainage, and therefore would</span>
<span class="sd">    be duplicative if summed).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_asums</span> <span class="o">=</span> <span class="n">asums</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">comid</span><span class="p">,</span> <span class="n">asum</span> <span class="ow">in</span> <span class="n">new_asums</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="c1"># get the asum at the line start</span>
        <span class="c1"># (tribs themselves might be distributaries,</span>
        <span class="c1"># so might reflect some of the same upstream drainage,</span>
        <span class="c1"># in which case summing the asums would be invalid)</span>
        <span class="n">tribs</span> <span class="o">=</span> <span class="n">graph_r</span><span class="p">[</span><span class="n">comid</span><span class="p">]</span>
        <span class="n">max_trib_asum</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tribs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">max_trib_asum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">new_asums</span><span class="p">[</span><span class="n">trib</span><span class="p">]</span> <span class="k">for</span> <span class="n">trib</span> <span class="ow">in</span> <span class="n">tribs</span><span class="p">])</span>

        <span class="c1"># expected asum is the highest trib asum + line length</span>
        <span class="n">expected_asum</span> <span class="o">=</span> <span class="n">max_trib_asum</span> <span class="o">+</span> <span class="n">fl_lengths</span><span class="p">[</span><span class="n">comid</span><span class="p">]</span>

        <span class="c1"># if the asum is less than expected</span>
        <span class="c1"># assume a break in asum continuity</span>
        <span class="k">if</span> <span class="n">expected_asum</span> <span class="o">&gt;</span> <span class="n">asum</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">find_path</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">comid</span><span class="p">)</span>

            <span class="c1"># set the current asum to the max of the tribs + it&#39;s line length</span>
            <span class="c1"># (current asum is at end of line)</span>
            <span class="n">asum_c</span> <span class="o">=</span> <span class="n">expected_asum</span>  <span class="c1"># current asum</span>
            <span class="n">new_asums</span><span class="p">[</span><span class="n">comid</span><span class="p">]</span> <span class="o">=</span> <span class="n">asum_c</span>

            <span class="c1"># increment each downstream line by the increase in asum</span>
            <span class="n">increment</span> <span class="o">=</span> <span class="n">asum_c</span> <span class="o">-</span> <span class="n">asum</span>
            <span class="c1"># for each comid going downstream</span>
            <span class="k">for</span> <span class="n">cp</span> <span class="ow">in</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="c1"># end condition is an outlet</span>
                <span class="k">if</span> <span class="n">cp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">old_asum</span> <span class="o">=</span> <span class="n">new_asums</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span>
                <span class="n">asum_c</span> <span class="o">=</span> <span class="n">old_asum</span> <span class="o">+</span> <span class="n">increment</span>
                <span class="n">new_asums</span><span class="p">[</span><span class="n">cp</span><span class="p">]</span> <span class="o">=</span> <span class="n">asum_c</span>
    <span class="k">return</span> <span class="n">new_asums</span></div>



<div class="viewcode-block" id="get_netcdf_crs_from_grid_mapping">
<a class="viewcode-back" href="../../api/sfrmaker.preprocessing.html#sfrmaker.preprocessing.get_netcdf_crs_from_grid_mapping">[docs]</a>
<span class="k">def</span> <span class="nf">get_netcdf_crs_from_grid_mapping</span><span class="p">(</span><span class="n">grid_mapping</span><span class="p">):</span>
    <span class="n">crs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_cf</span><span class="p">(</span><span class="n">grid_mapping</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="s1">&#39;crs_wkt&#39;</span> <span class="ow">in</span> <span class="n">grid_mapping</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">grid_mapping</span><span class="p">[</span><span class="s1">&#39;crs_wkt&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="c1"># Soil Water Balance Code output</span>
    <span class="c1"># usually has a &quot;proj4_string&quot; entry</span>
    <span class="k">if</span> <span class="s1">&#39;proj4_string&#39;</span> <span class="ow">in</span> <span class="n">grid_mapping</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="p">(</span><span class="n">grid_mapping</span><span class="p">[</span><span class="s1">&#39;proj4_string&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="c1"># could add more crazy try/excepts here</span>
    <span class="k">return</span> <span class="n">crs</span></div>

    
    
<div class="viewcode-block" id="swb_runoff_to_csv">
<a class="viewcode-back" href="../../api/sfrmaker.preprocessing.html#sfrmaker.preprocessing.swb_runoff_to_csv">[docs]</a>
<span class="k">def</span> <span class="nf">swb_runoff_to_csv</span><span class="p">(</span><span class="n">swb_runoff_netcdf_output</span><span class="p">,</span> <span class="n">nhdplus_catchments_file</span><span class="p">,</span>
                      <span class="n">runoff_output_variable</span><span class="o">=</span><span class="s1">&#39;runoff&#39;</span><span class="p">,</span>
                      <span class="n">swb_rejected_net_inf_output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">rejected_net_inf_variable</span><span class="o">=</span><span class="s1">&#39;rejected_net_infiltration&#39;</span><span class="p">,</span>
                      <span class="n">catchment_id_col</span><span class="o">=</span><span class="s1">&#39;FEATUREID&#39;</span><span class="p">,</span>
                      <span class="n">limit_runoff_to_area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">start_datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">output_length_units</span><span class="o">=</span><span class="s1">&#39;meters&#39;</span><span class="p">,</span>
                      <span class="n">include_xy_in_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xy_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;swb_runoff_by_nhdplus_comid.csv&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert gridded runoff estimates from the USGS Soil Water Balance Code (SWB)</span>
<span class="sd">    to a CSV format, associating each runoff value with a catchment ID. For the runoff to</span>
<span class="sd">    be successfully mapped to the SFR network, the catchment IDs must correspond to line IDs</span>
<span class="sd">    in the stream network, and each catchment must either be associated with a line, or</span>
<span class="sd">    be referenced in the flowline_routing dataset. See the documentation for </span>
<span class="sd">    :func:`sfrmaker.flows.add_to_perioddata` for more details.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    swb_runoff_netcdf_output : str or path-like</span>
<span class="sd">        NetCDF file with gridded SWB runoff estimates. Runoff values are assumed</span>
<span class="sd">        to be in units of length/time (normalized to area). The CRS for the runoff</span>
<span class="sd">        dataset is read from the &#39;proj4_string&#39; attribute, and is assumed to have</span>
<span class="sd">        length units of meters.</span>
<span class="sd">    nhdplus_catchments_file : str or path-like</span>
<span class="sd">        Shapefile of catchments with IDs (catchment_id_col). The catchments are rasterized</span>
<span class="sd">        to the grid in swb_netcdf_output, so that each runoff value can be associated with</span>
<span class="sd">        a catchment ID.</span>
<span class="sd">    catchment_id_col : str</span>
<span class="sd">        Field in nhdplus_catchments_file with ID, by default &#39;FEATUREID&#39;. </span>
<span class="sd">    runoff_output_variable : str, optional</span>
<span class="sd">        Variable in swb_runoff_netcdf_output with runoff data, by default &#39;runoff&#39;</span>
<span class="sd">    swb_rejected_net_inf_output : str or path-like</span>
<span class="sd">        NetCDF file with gridded SWB estimates of &quot;rejected net infiltration&quot;. </span>
<span class="sd">        This is infiltration in the SWB simulation in excess of the specified max</span>
<span class="sd">        infiltration rate. In reality this may represent a component of runoff</span>
<span class="sd">        or &#39;quick&#39; overland flow, depending on the timescale of the simulation.</span>
<span class="sd">        Values are assumed to be in units of length/time (normalized to area). </span>
<span class="sd">        The CRS for the runoff dataset is read from the &#39;proj4_string&#39; attribute, </span>
<span class="sd">        and is assumed to have length units of meters.</span>
<span class="sd">    rejected_net_inf_variable : str, optional</span>
<span class="sd">        Variable in swb_runoff_netcdf_output with runoff data, </span>
<span class="sd">        by default &#39;rejected_net_infiltration&#39;</span>
<span class="sd">    limit_runoff_to_area : str or path-like</span>
<span class="sd">        Optionally limit runoff to an area defined by a polygon shapefile.</span>
<span class="sd">        By default None, in which case runoff is aggregated for each</span>
<span class="sd">        NHDPlus Catchment that intersections the grid in swb_runoff_netcdf_output.</span>
<span class="sd">    start_datetime : str</span>
<span class="sd">        Include runoff on or after this date in the output. Can be in any </span>
<span class="sd">        string format used for time slicing in pandas or xarray.</span>
<span class="sd">        By default, None (include all times in `swb_runoff_netcdf_output`).</span>
<span class="sd">    end_datetime : str</span>
<span class="sd">        Include runoff on or before this date in the output. Can be in any </span>
<span class="sd">        string format used for time slicing in pandas or xarray.</span>
<span class="sd">        By default, None (include all times in `swb_runoff_netcdf_output`).</span>
<span class="sd">    output_length_units : str, optional</span>
<span class="sd">        Input units are read from the &#39;units&#39; attribute of the netcdf_output_variable </span>
<span class="sd">        in swb_netcdf_output; specify output length units so that the output CSV</span>
<span class="sd">        file is in the same length units as the model. No time unit conversion is perfo</span>
<span class="sd">        by default &#39;meters&#39;</span>
<span class="sd">    include_xy_in_output : bool</span>
<span class="sd">        Option to include approximate x, y coordinates of catchments in the</span>
<span class="sd">        output. The x, y coordinates represent the average x and y values of</span>
<span class="sd">        the SWB grid cells intersected by each catchment.</span>
<span class="sd">    xy_crs :</span>
<span class="sd">        Output coordinate reference system (CRS) for coordinates in outfile.</span>
<span class="sd">        Only used if `include_xy_in_output=True`.</span>
<span class="sd">        By default False, in which case the CRS for `swb_runoff_netcdf_output`</span>
<span class="sd">        is used.</span>
<span class="sd">    outfile : str, optional</span>
<span class="sd">        Output CSV file with transient runoff volumes for each catchment </span>
<span class="sd">        intersecting the SWB grid, by default &#39;swb_runoff_by_nhdplus_comid.csv&#39;</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    aggregated : DataFrame (also written to outfile)</span>
<span class="sd">        DataFrame with columns:</span>
<span class="sd">        </span>
<span class="sd">        =================== =============================================================</span>
<span class="sd">        time                time associated with each runoff volume</span>
<span class="sd">        comid               catchment and flowline identifier</span>
<span class="sd">        x                   (optional) approximate x-coordinate of catchment, in `xy_crs`</span>
<span class="sd">        y                   (optional) approximate y-coordinate of catchment, in `xy_crs`</span>
<span class="sd">        runoff_{L}3d        runoff volume, in model length units cubed per day</span>
<span class="sd">        area_{L}2           total area of SWB cells intersected by catchment, in model length units cubed</span>
<span class="sd">        =================== =============================================================</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Some notes on SWB output variables, as of 7/5/2023: </span>
<span class="sd">    </span>
<span class="sd">        * ``&#39;runoff_outside&#39;`` is the sum of ``&#39;runoff&#39;`` plus ``&#39;rejected_net_infiltration&#39;``. </span>
<span class="sd">        * When routing is inactive in the SWB simulation, ``&#39;runoff_outside&#39;`` is computed </span>
<span class="sd">          for every SWB grid cell. In this case, it can be supplied here to </span>
<span class="sd">          ``swb_runoff_netcdf_output`` (and ``runoff_output_variable``), in lieu of supplying both </span>
<span class="sd">          ``swb_runoff_netcdf_output`` and ``swb_rejected_net_inf_output``.</span>
<span class="sd">        * When routing is active, ``&#39;runoff_outside&#39;`` represents only water that cannot </span>
<span class="sd">          be moved downslope; in most cases it should be zero in the model interior. </span>
<span class="sd">          In this case, one would most likely supply both ``swb_runoff_netcdf_output`` and </span>
<span class="sd">          ``swb_rejected_net_inf_output``.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">outfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
    <span class="c1"># get an affine.Affine representation and shape </span>
    <span class="c1"># of the grid in the culled NetCDF file</span>
    <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">swb_runoff_netcdf_output</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">xul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">yul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># subset to time limits, if provided</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">start_datetime</span><span class="p">,</span> <span class="n">end_datetime</span><span class="p">))</span>
        <span class="n">ntimes</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">runoff_output_variable</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">nc_crs</span> <span class="o">=</span> <span class="n">get_netcdf_crs_from_grid_mapping</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">nc_bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">xul</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">yul</span><span class="p">)</span>
        <span class="n">nc_bbox</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">nc_bounds</span><span class="p">)</span>
        <span class="n">nc_units</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">runoff_output_variable</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
    <span class="n">nc_trans</span> <span class="o">=</span> <span class="n">affine</span><span class="o">.</span><span class="n">Affine</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">xul</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">yul</span><span class="p">)</span>
    
    <span class="c1"># combine runoff with &quot;rejected_net_infiltration&quot;</span>
    <span class="k">if</span> <span class="n">swb_rejected_net_inf_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">swb_rejected_net_inf_output</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds2</span><span class="p">:</span> 
            <span class="n">nc_crs2</span> <span class="o">=</span> <span class="n">get_netcdf_crs_from_grid_mapping</span><span class="p">(</span><span class="n">ds2</span><span class="p">[</span><span class="s1">&#39;crs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nc_crs2</span> <span class="o">!=</span> <span class="n">nc_crs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Files </span><span class="si">{</span><span class="n">swb_runoff_netcdf_output</span><span class="si">}</span><span class="s2"> (crs: </span><span class="si">{</span><span class="n">nc_crs</span><span class="si">}</span><span class="s2">) &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">swb_rejected_net_inf_output</span><span class="si">}</span><span class="s2"> (crs: </span><span class="si">{</span><span class="n">nc_crs2</span><span class="si">}</span><span class="s2">) have &quot;</span>
                                 <span class="s2">&quot;different coordinate reference systems. Are these &quot;</span>
                                 <span class="s2">&quot;from the same SWB simulation?&quot;</span><span class="p">)</span>
            <span class="n">ds2</span> <span class="o">=</span> <span class="n">ds2</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">start_datetime</span><span class="p">,</span> <span class="n">end_datetime</span><span class="p">))</span>
            <span class="n">total_runoff</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">runoff_output_variable</span><span class="p">]</span> <span class="o">+</span> <span class="n">ds2</span><span class="p">[</span><span class="n">rejected_net_inf_variable</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">total_runoff</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">runoff_output_variable</span><span class="p">]</span>
    <span class="n">total_runoff</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;runoff&#39;</span>
    
    <span class="c1"># plot average runoff, rejected net_inf, and total runoff</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mf">8.5</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span>
                             <span class="p">)</span>
    
    <span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;bottom&#39;</span><span class="p">}</span>
    <span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ds</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    
    <span class="c1"># compute the means to get global non-zero min and maxes</span>
    <span class="n">mean_runoff</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">runoff_output_variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">all_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean_runoff</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">mean_runoff</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">swb_rejected_net_inf_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mean_rjnet</span> <span class="o">=</span> <span class="n">ds2</span><span class="p">[</span><span class="n">rejected_net_inf_variable</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">all_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_rjnet</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">mean_rjnet</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">mean_total_runoff</span> <span class="o">=</span> <span class="n">total_runoff</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">all_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_total_runoff</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">mean_total_runoff</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">non_zero_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">all_values</span><span class="p">)</span>
    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">non_zero_values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">non_zero_values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>
    <span class="n">mean_runoff</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cbar_kwargs</span><span class="o">=</span><span class="n">cbar_kwargs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">(),</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">swb_rejected_net_inf_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>
        <span class="n">mean_rjnet</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cbar_kwargs</span><span class="o">=</span><span class="n">cbar_kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">(),</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>
    <span class="n">cbar_kwargs</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">runoff_output_variable</span><span class="si">}</span><span class="s1"> + &#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rejected_net_inf_variable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">mean_total_runoff</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cbar_kwargs</span><span class="o">=</span><span class="n">cbar_kwargs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">(),</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Average values for </span><span class="si">{</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="n">y</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;runoff_comparison.pdf&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Read in the NHDPlus catchments </span>
    <span class="c1"># first reproject the SWB netcdf bounding box to lat/lon (NAD83)</span>
    <span class="c1"># with a 10 km buffer</span>
    <span class="n">shapefile_crs</span> <span class="o">=</span> <span class="n">get_shapefile_crs</span><span class="p">(</span><span class="n">nhdplus_catchments_file</span><span class="p">)</span>
    <span class="n">nc_bbox</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">nc_bbox</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mf">1e4</span><span class="p">),</span> <span class="n">nc_crs</span><span class="p">,</span> <span class="n">shapefile_crs</span><span class="p">)</span>
    <span class="c1"># read the catchments intersecting the buffered bbox</span>
    <span class="n">catchments</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">nhdplus_catchments_file</span><span class="p">,</span> 
                               <span class="n">bbox</span><span class="o">=</span><span class="n">nc_bbox</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
                               <span class="n">dtypes</span><span class="o">=</span><span class="p">{</span><span class="n">catchment_id_col</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
    <span class="c1">#  reproject to the SWB output CRS (probably 5070)</span>
    <span class="c1">#  this assumes the SWB output has a valid crs!</span>
    <span class="k">if</span> <span class="n">shapefile_crs</span> <span class="o">!=</span> <span class="n">nc_crs</span><span class="p">:</span>
        <span class="n">catchments</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">nc_crs</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># rasterize the catchments unto the NetCDF file grid</span>
    <span class="n">features_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">catchments</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> 
                             <span class="n">catchments</span><span class="p">[</span><span class="n">catchment_id_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)))</span>
    <span class="n">rasterized</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span><span class="n">features_list</span><span class="p">,</span> <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">),</span> 
                                    <span class="n">transform</span><span class="o">=</span><span class="n">nc_trans</span><span class="p">)</span>
    <span class="n">out_text_array</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;nhdplus_catchments.dat&#39;</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">out_text_array</span><span class="p">,</span> <span class="n">rasterized</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;wrote </span><span class="si">{</span><span class="n">out_text_array</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">write_raster</span><span class="p">(</span><span class="n">out_text_array</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">),</span> <span class="n">rasterized</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                 <span class="n">xul</span><span class="o">=</span><span class="n">xul</span><span class="p">,</span> <span class="n">yul</span><span class="o">=</span><span class="n">yul</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">nc_crs</span><span class="p">)</span>
    
    <span class="c1"># normalize colors</span>
    <span class="n">unique_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rasterized</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">unique_values</span><span class="p">)</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_values</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                       <span class="p">))</span>
    <span class="n">to_show</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">mapping</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rasterized</span><span class="o">.</span><span class="n">ravel</span><span class="p">()],</span>
                         <span class="n">rasterized</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">to_show</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">rasterized</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">masked</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gist_earth&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Rasterized NHDPlus catchments&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_text_array</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.pdf&#39;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wrote </span><span class="si">{</span><span class="n">out_text_array</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.pdf&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
 
     <span class="c1"># transpose the SWB runoff results from xarray DataSet to DataFrame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">total_runoff</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;comid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rasterized</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">*</span> <span class="n">ntimes</span>
    
    <span class="c1"># optionally limit runoff to user-defined polygon area</span>
    <span class="k">if</span> <span class="n">limit_runoff_to_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">roff_area</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">limit_runoff_to_area</span><span class="p">)</span>
        <span class="n">roff_area</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">nc_crs</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">roff_area_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">roff_area</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">features_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">roff_area</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">roff_area_ids</span><span class="p">))</span>
        <span class="n">allow_runoff</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">rasterize</span><span class="p">(</span><span class="n">features_list</span><span class="p">,</span> <span class="n">out_shape</span><span class="o">=</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">),</span> 
                                        <span class="n">transform</span><span class="o">=</span><span class="n">nc_trans</span><span class="p">)</span>     
        <span class="n">loc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">allow_runoff</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">ntimes</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">runoff_area_outfile</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;runoff_area.tif&#39;</span>
        <span class="n">write_raster</span><span class="p">(</span><span class="n">runoff_area_outfile</span><span class="p">,</span> <span class="n">allow_runoff</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                    <span class="n">xul</span><span class="o">=</span><span class="n">xul</span><span class="p">,</span> <span class="n">yul</span><span class="o">=</span><span class="n">yul</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">nc_crs</span><span class="p">)</span>
        <span class="n">masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">allow_runoff</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">allow_runoff</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">masked</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Rasterized runoff area&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">runoff_area_outfile</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.pdf&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wrote </span><span class="si">{</span><span class="n">runoff_area_outfile</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.pdf&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># SWB runoff is in average daily inches over each cell</span>
    <span class="c1"># convert to average daily volume for each cell</span>
    <span class="c1"># then sum by comid to get average daily volume by comid</span>
    <span class="c1"># (which can subsequently be distributed equally to reaches)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">unit_abbreviations</span><span class="p">[</span><span class="n">output_length_units</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;area_</span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1">2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span>  <span class="c1"># cell area in m3</span>
    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;runoff_</span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;runoff&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">convert_length_units</span><span class="p">(</span><span class="n">nc_units</span><span class="p">,</span> <span class="n">output_length_units</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;runoff_</span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1">3d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;runoff_</span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1">d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;area_</span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1">2&#39;</span><span class="p">]</span>
    <span class="n">bycomid_time</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;comid&#39;</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bycomid_time</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>  <span class="c1"># preserve times</span>
    <span class="c1"># sum the runoff for all cells intersecting each catchment</span>
    <span class="c1"># (at each time)</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">bycomid_time</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">data_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">aggregated</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">aggregated</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">include_xy_in_output</span><span class="p">:</span>
        <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bycomid_time</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bycomid_time</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">xy_crs</span> <span class="o">!=</span> <span class="n">nc_crs</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span>
                <span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]),</span> <span class="n">nc_crs</span><span class="p">,</span> <span class="n">xy_crs</span><span class="p">)</span>
            <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>          

    <span class="c1"># remap aggregated runoff back to COMIDs </span>
    <span class="c1"># and compare to gridded total runoff from SWB</span>
    <span class="n">geoms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">catchments</span><span class="p">[</span><span class="n">catchment_id_col</span><span class="p">],</span> <span class="n">catchments</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]))</span>
    <span class="c1"># get the mean for each catchment through time</span>
    <span class="n">comid_runoff_means</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">aggregated</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;comid&#39;</span><span class="p">)[</span><span class="s1">&#39;runoff_m3d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">comid_runoff_means</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mean_roff&#39;</span><span class="p">]</span>
    <span class="n">comid_runoff_means</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">geoms</span><span class="p">[</span><span class="n">comid</span><span class="p">]</span> 
                                       <span class="k">for</span> <span class="n">comid</span> <span class="ow">in</span> <span class="n">comid_runoff_means</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="c1"># keep unconverted linear runoff from SWB for diagnostic/QC purposes</span>
    <span class="c1"># (for example, this allows for direct comparison of a catchment intersecting </span>
    <span class="c1"># a single SWB cell to the SWB output)</span>
    <span class="n">comid_runoff_means</span><span class="p">[</span><span class="s1">&#39;runoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">aggregated</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;comid&#39;</span><span class="p">)[</span><span class="s1">&#39;runoff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">comid_runoff_means</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">comid_runoff_means</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">catchments</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mf">8.5</span><span class="p">),</span> 
                             <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;constrained&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">non_zero</span> <span class="o">=</span> <span class="n">comid_runoff_means</span><span class="p">[</span><span class="s1">&#39;mean_roff&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">catchments_norm</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span>
        <span class="n">comid_runoff_means</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">non_zero</span><span class="p">,</span> <span class="s1">&#39;mean_roff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
        <span class="n">comid_runoff_means</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">non_zero</span><span class="p">,</span> <span class="s1">&#39;mean_roff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">comid_runoff_means</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">column</span><span class="o">=</span><span class="s1">&#39;mean_roff&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">catchments_norm</span><span class="p">,</span>
        <span class="n">legend_kwds</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;Mean runoff mapped to catchments, &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;in </span><span class="si">{</span><span class="n">output_length_units</span><span class="si">}</span><span class="s1">$^3$/day&#39;</span><span class="p">),</span>
            <span class="s1">&#39;orientation&#39;</span><span class="p">:</span> <span class="s1">&#39;horizontal&#39;</span>
                     <span class="p">},</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
    <span class="n">xlim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
    <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="n">aspect</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">(),</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cbar_kwargs</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean SWB </span><span class="si">{</span><span class="n">runoff_output_variable</span><span class="si">}</span><span class="s1"> + &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rejected_net_inf_variable</span><span class="si">}</span><span class="s1">, in </span><span class="si">{</span><span class="n">nc_units</span><span class="si">}</span><span class="s1">/day&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">limit_runoff_to_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plot_array</span> <span class="o">=</span> <span class="n">mean_total_runoff</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">allow_runoff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_array</span> <span class="o">=</span> <span class="n">mean_total_runoff</span>
    <span class="n">plot_array</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cbar_kwargs</span><span class="o">=</span><span class="n">cbar_kwargs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">(),</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="c1">#ax.set_ylim(*ylim)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">comid_runoff_means</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">mean_total_runoff_pdf</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;mean_total_runoff_comparison.pdf&#39;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Average values for </span><span class="si">{</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1">#plt.subplots_adjust(top=0.1)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">mean_total_runoff_pdf</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wrote </span><span class="si">{</span><span class="n">mean_total_runoff_pdf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
       
    <span class="c1"># export to GIS layers as well</span>
    <span class="n">mean_total_runoff_shp</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;mean_total_runoff_by_catchment.shp&#39;</span>
    <span class="n">comid_runoff_means</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">mean_total_runoff_shp</span><span class="p">)</span> 
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wrote </span><span class="si">{</span><span class="n">mean_total_runoff_shp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">mean_total_runoff_raster</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;mean_total_runoff_on_swb_grid.tif&#39;</span>
    <span class="k">if</span> <span class="n">limit_runoff_to_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_array</span> <span class="o">=</span> <span class="n">mean_total_runoff</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">allow_runoff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_array</span> <span class="o">=</span> <span class="n">mean_total_runoff</span><span class="o">.</span><span class="n">values</span>
    <span class="n">write_raster</span><span class="p">(</span><span class="n">mean_total_runoff_raster</span><span class="p">,</span> 
                 <span class="n">output_array</span><span class="p">,</span>
                 <span class="n">nodata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                 <span class="n">xul</span><span class="o">=</span><span class="n">xul</span><span class="p">,</span> <span class="n">yul</span><span class="o">=</span><span class="n">yul</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">dy</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">nc_crs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wrote </span><span class="si">{</span><span class="n">mean_total_runoff_raster</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="c1"># drop comids with zero total runoff</span>
    <span class="c1"># (keep intermittent zero values; </span>
    <span class="c1">#  otherwise SFR package will continue previous value)</span>
    <span class="n">comid_runoff_totals</span> <span class="o">=</span> <span class="n">aggregated</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;comid&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">runoff</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">drop_comids</span> <span class="o">=</span> <span class="n">comid_runoff_totals</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid_runoff_totals</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
    <span class="n">keep_rows</span> <span class="o">=</span> <span class="o">~</span><span class="n">aggregated</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">drop_comids</span><span class="p">)</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">aggregated</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keep_rows</span><span class="p">]</span>
    <span class="n">output_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">include_xy_in_output</span><span class="p">:</span>
        <span class="n">output_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>
    <span class="n">output_cols</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;runoff_</span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1">3d&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;area_</span><span class="si">{</span><span class="n">L</span><span class="si">}</span><span class="s1">2&#39;</span><span class="p">]</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">aggregated</span><span class="p">[</span><span class="n">output_cols</span><span class="p">]</span>
    <span class="n">aggregated</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;wrote </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">aggregated</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">Last updated on Jan 15, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>